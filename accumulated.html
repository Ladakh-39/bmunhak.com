<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>누적기록 | jungdap.com</title>
  <link rel="icon" href="/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT@2/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet" />
  <style>
    :root {
      --jd-header: #7092BE;
    }
    body { font-family: "SUIT Variable", -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
    .mono { font-variant-numeric: tabular-nums; }
    .answer-cell {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-weight: 900;
      font-size: 13px;
      color: #334155;
      background: #fff;
      padding: 0 8px;
    }
    .answer-cell.ok { border-color: #22c55e; background: #f0fdf4; color: #15803d; }
    .answer-cell.ng { border-color: #f43f5e; background: #fff1f2; color: #be123c; }
    .difficulty-stars {
      font-weight: 900;
      letter-spacing: -0.02em;
    }
    .footer-logo {
      height: 86px;
      width: auto;
      display: block;
    }
    .hc-shell {
      max-width: 1440px;
      margin: 0 auto;
      padding: 0 16px;
    }
  </style>
</head>
<body class="min-h-screen bg-white">
  <header class="border-b border-slate-400 bg-[#7092BE] text-white overflow-hidden">
    <div class="hc-shell">
      <div class="flex h-16 items-center gap-4 overflow-hidden">
        <div class="flex items-center min-w-[160px]">
          <a href="/" class="block">
            <span class="block text-[34px] leading-none font-black tracking-tight text-[#33506a]">bmunhak</span>
          </a>
        </div>

        <nav class="hidden md:flex flex-1 items-center justify-center gap-5 lg:gap-7 text-[18px] lg:text-[21px] leading-none min-w-0 flex-nowrap whitespace-nowrap">
          <span class="room-secret-slot inline-flex items-center justify-center w-[104px] whitespace-nowrap">
            <a id="room-of-requirement" href="/board.html?b=room" class="room-secret-prehide leading-none transition-colors whitespace-nowrap" style="visibility:hidden;pointer-events:none;">필요의 방</a>
          </span>
          <a href="/board.html?b=notice" class="leading-none hover:underline whitespace-nowrap">공지사항</a>
          <a href="/board.html?b=intro" class="leading-none hover:underline whitespace-nowrap">가입인사</a>
          <a href="/board.html?b=free" class="leading-none hover:underline whitespace-nowrap">자유게시판</a>
          <a href="/board.html?b=qna" class="leading-none hover:underline whitespace-nowrap">질문</a>
          <a href="/grader.html" class="leading-none hover:underline whitespace-nowrap">채점하기</a>
          <a href="/my.html" class="leading-none hover:underline whitespace-nowrap">My Page</a>
        </nav>

        <div class="hidden md:flex items-center justify-end gap-3 min-w-[140px] whitespace-nowrap">
          <button id="btnSignupTop" type="button" class="hover:underline whitespace-nowrap">회원가입</button>
          <button id="btnLoginTop" type="button" class="hover:underline whitespace-nowrap">로그인</button>
          <span id="welcomeText" class="hidden text-sm font-bold whitespace-nowrap"></span>
          <button id="btnLogoutTop" type="button" class="hidden hover:underline whitespace-nowrap">로그아웃</button>
        </div>

        <button id="btnMobileMenu" class="md:hidden px-3 py-2 rounded-lg hover:bg-white/10" type="button" aria-label="menu">
          ☰
        </button>
      </div>

      <div id="mobileMenu" class="md:hidden hidden pb-3">
        <div class="flex flex-col gap-2 text-base font-bold">
          <a id="room-of-requirement-mobile" href="/board.html?b=room" class="room-secret-prehide hidden px-3 py-2 rounded-lg transition-colors whitespace-nowrap" style="visibility:hidden;pointer-events:none;">필요의 방</a>
          <a href="/board.html?b=notice" class="px-3 py-2 rounded-lg hover:bg-white/10 whitespace-nowrap">공지사항</a>
          <a href="/board.html?b=intro" class="px-3 py-2 rounded-lg hover:bg-white/10 whitespace-nowrap">가입인사</a>
          <a href="/board.html?b=free" class="px-3 py-2 rounded-lg hover:bg-white/10 whitespace-nowrap">자유게시판</a>
          <a href="/board.html?b=qna" class="px-3 py-2 rounded-lg hover:bg-white/10 whitespace-nowrap">질문</a>
          <a href="/grader.html" class="px-3 py-2 rounded-lg hover:bg-white/10 whitespace-nowrap">채점하기</a>
          <a href="/my.html" class="px-3 py-2 rounded-lg hover:bg-white/10 whitespace-nowrap">My Page</a>

          <div class="flex items-center gap-3 px-3 pt-2">
            <button id="btnSignupMobile" class="hover:underline whitespace-nowrap" type="button">회원가입</button>
            <button id="btnLoginMobile" class="hover:underline whitespace-nowrap" type="button">로그인</button>
            <button id="btnLogoutMobile" class="hidden hover:underline whitespace-nowrap" type="button">로그아웃</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="hc-shell py-6">
    <section class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <h1 class="text-[26px] leading-[1.05] font-extrabold text-slate-900 tracking-tight">누적기록</h1>
        <a id="backToRecords" href="/records.html" class="px-4 py-2 rounded-2xl border-2 border-slate-200 bg-white font-black hover:bg-slate-50">내 기록 목록</a>
      </div>
      <p class="mt-2 text-sm font-bold text-slate-500">학년도/영역 기준으로 누적된 답안 매트릭스를 보여줍니다.</p>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label for="yearSelect" class="block text-xs font-black text-slate-400 mb-1 ml-1">학년도</label>
          <select id="yearSelect" class="w-full p-3 rounded-2xl border-2 border-slate-200 bg-slate-50 font-black"></select>
        </div>
        <div>
          <label for="sectionSelect" class="block text-xs font-black text-slate-400 mb-1 ml-1">영역</label>
          <select id="sectionSelect" class="w-full p-3 rounded-2xl border-2 border-slate-200 bg-slate-50 font-black">
            <option value="lang">언어이해</option>
            <option value="logic">추리논증</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btnReload" class="w-full px-4 py-3 rounded-2xl bg-slate-900 text-white font-black hover:opacity-90">조회</button>
        </div>
      </div>
    </section>

    <section class="mt-4 bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
      <h2 class="text-[26px] leading-[1.05] font-extrabold text-slate-900 tracking-tight">회차 요약</h2>
      <div class="mt-3 overflow-x-auto rounded-2xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr class="text-slate-500 font-black">
              <th class="px-3 py-3 text-left w-[80px]">회차</th>
              <th class="px-3 py-3 text-left w-[120px]">채점일</th>
              <th class="px-3 py-3 text-left w-[120px]">형식</th>
              <th class="px-3 py-3 text-left w-[120px]">점수</th>
              <th class="px-3 py-3 text-left w-[120px]">표준점수</th>
              <th class="px-3 py-3 text-left w-[100px]">백분위</th>
            </tr>
          </thead>
          <tbody id="attemptSummaryBody" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>
    </section>

    <section class="mt-4 bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
      <h2 class="text-[26px] leading-[1.05] font-extrabold text-slate-900 tracking-tight">답안 매트릭스</h2>
      <div id="matrixHint" class="mt-2 text-xs font-bold text-slate-400">로딩 중...</div>
      <div class="mt-3 overflow-x-auto rounded-2xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead id="matrixHead" class="bg-slate-50 border-b border-slate-200"></thead>
          <tbody id="matrixBody" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="mt-8 border-t border-slate-300 bg-[#efefef] py-8">
    <div class="hc-shell">
      <div class="grid grid-cols-1 md:grid-cols-3 items-end gap-6 text-sm font-bold text-slate-600">
        <div class="flex items-center justify-center md:justify-start gap-4 md:self-end">
          <button id="btnContactOpen" class="hover:underline">문의</button>
          <a href="/terms.html" class="hover:underline">이용약관</a>
          <a href="/privacy.html" class="hover:underline">개인정보처리방침</a>
        </div>
        <div class="flex justify-center md:self-end">
          <a href="/" class="block">
            <span class="block text-[44px] leading-none font-black tracking-tight text-slate-700">bmunhak.com</span>
          </a>
        </div>
        <div class="flex items-center justify-center md:justify-end gap-3 md:self-end">
          <img src="/assets/kakao-qr.png" alt="kakao qr" class="h-14 w-14 border border-slate-300 bg-white p-1" />
          <button id="btnCopyKakaoLink" class="px-3 py-1 border border-slate-300 bg-white hover:bg-slate-100">링크복사</button>
        </div>
      </div>
    </div>
  </footer>

  <div id="contactModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 p-4 z-[60]">
    <div class="w-full max-w-lg bg-white border border-slate-300 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-black text-slate-900">문의하기</h3>
        <button id="btnCloseContact" class="px-3 py-1 border border-slate-300 hover:bg-slate-100">닫기</button>
      </div>
      <div class="grid gap-4">
        <p class="text-sm font-bold text-slate-600">아래 QR 또는 링크 복사로 오픈채팅에 접속해 주세요.</p>
        <div class="flex flex-col sm:flex-row items-center gap-4">
          <img src="/assets/kakao-qr.png" alt="kakao qr large" class="h-44 w-44 border border-slate-300 bg-white p-2" />
          <div class="grid gap-2 w-full">
            <button id="btnCopyKakaoLink2" class="px-3 py-2 border border-slate-300 bg-white font-black hover:bg-slate-100">링크 복사</button>
            <div class="text-xs font-bold text-slate-500 break-all" id="kakaoLinkPreview"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="copyToast" class="fixed hidden items-center justify-center bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 bg-slate-900 text-white text-sm font-black z-[70]">복사됨</div>

  <script src="/app.js?v=20260226-1"></script>
  <script>
    const APP = window.JungdapApp;
    const sbClient = APP.getSb();

    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const yearFromQs = String(qs.get("year") || "");
    const sectionFromQs = String(qs.get("section") || "lang");
    const HIDE_DIFFICULTY_YEARS = new Set(["2009_pre", "2009", "2010"]);
    const YEARS = (() => {
      const arr = ["2009_pre"];
      for (let y = 2010; y <= 2026; y += 1) arr.push(String(y));
      return arr.reverse();
    })();

    let currentUser = null;
    let profileNickname = "";

    function fmtDate(ts) {
      const d = new Date(ts);
      if (!Number.isFinite(d.getTime())) return "-";
      const yy = String(d.getFullYear()).slice(2);
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yy}/${mm}/${dd}`;
    }
    function formLabel(form) {
      return form === "even" ? "짝수형" : "홀수형";
    }
    function shouldHideDifficulty(year) {
      return HIDE_DIFFICULTY_YEARS.has(String(year || ""));
    }
    function difficultyStarsText(starsMap, row) {
      const qid = String(row?.question_id ?? row?.qno ?? row?.item_no ?? "").trim();
      const starN = Number(starsMap?.[qid]);
      if (Number.isFinite(starN) && starN >= 1 && starN <= 5) return "★".repeat(Math.trunc(starN));
      return "-";
    }

    async function getProfileNicknameByUserId(uid) {
      if (!uid) return "";
      const { data } = await sbClient.from("profiles").select("nickname").eq("user_id", uid).maybeSingle();
      return String(data?.nickname || "").trim();
    }

    async function getMyDisplayName() {
      if (!currentUser) return "";
      if (profileNickname) return profileNickname;
      profileNickname = await getProfileNicknameByUserId(currentUser.id);
      if (profileNickname) return profileNickname;
      return String(currentUser.email || "").split("@")[0] || String(currentUser.id || "").slice(0, 8);
    }

    function clearAll(message) {
      $("attemptSummaryBody").innerHTML = "";
      $("matrixHead").innerHTML = "";
      $("matrixBody").innerHTML = "";
      $("matrixHint").textContent = message || "";
    }

    function fillYearOptions() {
      $("yearSelect").innerHTML = YEARS.map((y) => `<option value="${y}">${y === "2009_pre" ? "2009 예비" : y}</option>`).join("");
      $("yearSelect").value = YEARS.includes(yearFromQs) ? yearFromQs : "2026";
      $("sectionSelect").value = sectionFromQs === "logic" ? "logic" : "lang";
    }

    async function loadAccumulated() {
      if (!currentUser) return;
      clearAll("조회 중...");

      const year = $("yearSelect").value;
      const section = $("sectionSelect").value;
      $("backToRecords").href = `/records.html?year=${encodeURIComponent(year)}&section=${encodeURIComponent(section)}`;

      const buildAttemptQuery = () => {
        let query = sbClient
          .from("exam_attempts")
          .select("id,created_at,year,section,form,raw_score,official_total,standard_score,percentile")
          .eq("user_id", currentUser.id)
          .eq("year", year)
          .eq("section", section)
          .eq("is_deleted", false);
        return query.order("created_at", { ascending: true });
      };

      const [attemptRes, masterRes] = await Promise.all([
        buildAttemptQuery(),
        fetch(`/.netlify/functions/get-master-sheet?year=${encodeURIComponent(year)}&section=${encodeURIComponent(section)}`)
      ]);

      if (attemptRes.error) {
        clearAll(`오류: ${attemptRes.error.message}`);
        return;
      }
      const attempts = attemptRes.data || [];
      if (!attempts.length) {
        clearAll("기록이 없습니다.");
        return;
      }

      const masterJson = await masterRes.json().catch(() => null);
      if (!masterRes.ok || !masterJson?.ok || !Array.isArray(masterJson?.rows)) {
        clearAll("마스터시트를 불러오지 못했습니다.");
        return;
      }
      const masterRows = masterJson.rows || [];
      if (!masterRows.length) {
        clearAll("기록이 없습니다.");
        return;
      }

      let starsMap = {};
      if (!shouldHideDifficulty(year)) {
        try {
          const starsRes = await fetch(`/.netlify/functions/get-difficulty-stars?year=${encodeURIComponent(year)}&section=${encodeURIComponent(section)}`);
          const starsJson = await starsRes.json().catch(() => null);
          if (starsRes.ok && starsJson?.ok && starsJson?.stars && typeof starsJson.stars === "object") {
            starsMap = starsJson.stars;
          }
        } catch (_error) {
          starsMap = {};
        }
      }

      $("attemptSummaryBody").innerHTML = attempts.map((a, idx) => `
        <tr>
          <td class="px-3 py-2 font-black mono text-slate-700">${idx + 1}</td>
          <td class="px-3 py-2 font-black mono text-slate-500">${fmtDate(a.created_at)}</td>
          <td class="px-3 py-2 font-black text-slate-700">${formLabel(a.form)}</td>
          <td class="px-3 py-2 font-black mono text-slate-700">${a.raw_score ?? "-"} / ${a.official_total ?? "-"}</td>
          <td class="px-3 py-2 font-black mono text-slate-700">${a.standard_score ?? "-"}</td>
          <td class="px-3 py-2 font-black mono text-slate-700">${a.percentile ?? "-"}</td>
        </tr>
      `).join("");

      const attemptIds = attempts.map((a) => a.id);
      const { data: itemRows, error: itemError } = await sbClient
        .from("exam_attempt_items")
        .select("attempt_id,item_no,my_answer,is_correct")
        .in("attempt_id", attemptIds)
        .order("item_no", { ascending: true });
      if (itemError) {
        clearAll(`오류: ${itemError.message}`);
        return;
      }

      const itemByAttempt = new Map();
      for (const a of attempts) itemByAttempt.set(a.id, new Map());
      for (const row of (itemRows || [])) {
        const m = itemByAttempt.get(row.attempt_id);
        if (m) m.set(Number(row.item_no), row);
      }

      const headCols = attempts.map((a, idx) => `<th class="px-3 py-3 text-left w-[96px]">${idx + 1}회차<br><span class="mono text-[11px]">${fmtDate(a.created_at)}</span></th>`).join("");
      $("matrixHead").innerHTML = `
        <tr class="text-slate-500 font-black">
          <th class="px-3 py-3 text-left w-[70px]">문항</th>
          <th class="px-3 py-3 text-left w-[90px]">난이도</th>
          <th class="px-3 py-3 text-left w-[110px]">정답(홀/짝)</th>
          ${headCols}
        </tr>
      `;

      const rowsHtml = masterRows.map((row) => {
        const odd = row.odd_answer ?? "-";
        const even = row.even_answer ?? "-";
        const ans = (odd !== "-" && odd === even) ? `${odd}` : `${odd}(${even})`;
        const cells = attempts.map((attempt) => {
          const keyNo = attempt.form === "even" ? Number(row.even_item_no) : Number(row.odd_item_no);
          const item = itemByAttempt.get(attempt.id)?.get(keyNo) || null;
          if (!item || item.my_answer == null) return '<td class="px-3 py-2"><span class="answer-cell">-</span></td>';
          const cls = item.is_correct === true ? "ok" : item.is_correct === false ? "ng" : "";
          return `<td class="px-3 py-2"><span class="answer-cell ${cls}">${item.my_answer}</span></td>`;
        }).join("");
        return `
          <tr>
            <td class="px-3 py-2 font-black mono text-slate-700">${row.question_id ?? "-"}</td>
            <td class="px-3 py-2 difficulty-stars text-slate-700">${difficultyStarsText(starsMap, row)}</td>
            <td class="px-3 py-2 font-black mono text-slate-700">${ans}</td>
            ${cells}
          </tr>
        `;
      }).join("");
      $("matrixBody").innerHTML = rowsHtml;
      $("matrixHint").textContent = `총 ${masterRows.length}문항 · ${attempts.length}회차`;
    }

    async function syncAuthUI(session) {
      currentUser = session?.user || null;
      const signedIn = Boolean(currentUser);
      $("welcomeText").classList.toggle("hidden", !signedIn);
      $("btnLogoutTop").classList.toggle("hidden", !signedIn);
      $("btnLoginTop").classList.toggle("hidden", signedIn);
      $("btnSignupTop").classList.toggle("hidden", signedIn);
      if (signedIn) {
        profileNickname = await getProfileNicknameByUserId(currentUser.id);
        $("welcomeText").textContent = `${await getMyDisplayName()}님`;
        $("welcomeText").style.color = "#212d2b";
      } else {
        $("welcomeText").style.color = "";
      }
    }

    $("btnLoginTop")?.addEventListener("click", () => APP.openAuth("login"));
    $("btnSignupTop")?.addEventListener("click", () => APP.openAuth("signup"));
    $("btnLoginMobile")?.addEventListener("click", () => APP.openAuth("login"));
    $("btnSignupMobile")?.addEventListener("click", () => APP.openAuth("signup"));
    $("btnLogoutTop").addEventListener("click", async () => {
      await APP.hardSignOut(sbClient);
    });
    $("btnReload").addEventListener("click", loadAccumulated);
    $("yearSelect").addEventListener("change", loadAccumulated);
    $("sectionSelect").addEventListener("change", loadAccumulated);

    (async function init() {
      APP.setupMobileMenu("btnMobileMenu", "mobileMenu");
      APP.setupContactModal();
      APP.setupAuthModal();
      APP.setupSecretRoomHover({
        elementId: "room-of-requirement",
        hiddenColor: "#7092BE",
        hoverColor: "#7496C2",
        openColor: "#FFFFFF",
        requiredCount: 3,
        withinMs: 1500,
        resetMs: 1500
      });
      const preview = $("kakaoLinkPreview");
      if (preview) preview.textContent = APP.getKakaoOpenChatUrl();
      fillYearOptions();
      const { data } = await sbClient.auth.getSession();
      await syncAuthUI(data.session);
      sbClient.auth.onAuthStateChange(async (_evt, session) => {
        await syncAuthUI(session);
        if (session?.user) loadAccumulated();
        else {
          clearAll("로그인이 필요합니다.");
          APP.openAuth("login");
        }
      });
      if (!data.session) {
        clearAll("로그인이 필요합니다.");
        APP.openAuth("login");
        return;
      }
      await loadAccumulated();
    })();
  </script>
</body>
</html>


