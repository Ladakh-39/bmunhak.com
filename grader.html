<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bmunhak 채점하기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #e5e7eb; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .mono { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="min-h-screen">
<header class="border-b border-slate-400 bg-[#7b90b8] text-white">
    <div class="mx-auto flex h-16 max-w-[1180px] items-center gap-4 px-4">
        <a href="/index.html" class="text-[34px] leading-none font-black tracking-tight text-[#2f4d66]">bmunhak</a>
        <nav class="hidden flex-1 items-center justify-center gap-7 text-[18px] font-semibold md:flex">
            <a href="/board.html?b=notice" class="hover:underline">공지사항</a>
            <a href="/board.html?b=intro" class="hover:underline">가입인사</a>
            <a href="/board.html?b=free" class="hover:underline">자유게시판</a>
            <a href="/board.html?b=qna" class="hover:underline">질문</a>
            <a href="/grader.html" class="hover:underline">채점하기</a>
            <a href="/my.html" class="hover:underline">My Page</a>
        </nav>
        <div class="hidden items-center gap-3 text-sm font-semibold md:flex">
            <button id="btnSignupTop" type="button" class="hover:underline">회원가입</button>
            <button id="btnLoginTop" type="button" class="hover:underline">로그인</button>
            <span id="welcomeText" class="hidden text-sm font-bold"></span>
            <button id="btnLogoutTop" type="button" class="hidden hover:underline">로그아웃</button>
        </div>
        <button id="btnMenu" class="rounded-lg px-3 py-2 text-2xl md:hidden" type="button">☰</button>
    </div>
    <div id="mobileMenu" class="mx-auto hidden max-w-[1180px] px-4 pb-3 md:hidden">
        <div class="grid gap-1 text-xl font-semibold">
            <a href="/board.html?b=notice" class="rounded px-2 py-1 hover:bg-white/10">공지사항</a>
            <a href="/board.html?b=intro" class="rounded px-2 py-1 hover:bg-white/10">가입인사</a>
            <a href="/board.html?b=free" class="rounded px-2 py-1 hover:bg-white/10">자유게시판</a>
            <a href="/board.html?b=qna" class="rounded px-2 py-1 hover:bg-white/10">질문</a>
            <a href="/grader.html" class="rounded px-2 py-1 hover:bg-white/10">채점하기</a>
            <a href="/my.html" class="rounded px-2 py-1 hover:bg-white/10">My Page</a>
        </div>
        <div class="flex items-center gap-3 px-3 pt-2">
            <button id="btnSignupMobile" class="hover:underline" type="button">회원가입</button>
            <button id="btnLoginMobile" class="hover:underline" type="button">로그인</button>
            <button id="btnLogoutMobile" class="hidden hover:underline" type="button">로그아웃</button>
        </div>
    </div>
</header>

<main class="px-4 py-8">
    <section class="mx-auto max-w-[1180px] border border-slate-300 bg-white p-5 shadow-sm md:p-7">
        <div class="mb-5 flex flex-wrap items-end gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900 md:text-4xl">마더텅 독서 채점기</h1>
                <p class="mt-1 text-sm font-bold text-slate-500">jungdap 스타일 숫자 입력형 채점</p>
            </div>
            <div id="statusMsg" class="ml-auto text-xs font-black text-slate-500"></div>
        </div>

        <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
            <div>
                <label for="subjectSelect" class="mb-1 ml-1 block text-xs font-black text-slate-400">과목 선택</label>
                <select id="subjectSelect" class="w-full border-2 border-slate-200 bg-slate-50 p-3 text-base font-black outline-none focus:border-blue-500">
                    <option value="humanities">Ⅰ. 인문 (001~213)</option>
                    <option value="social">Ⅱ. 사회 (001~169)</option>
                    <option value="science">Ⅲ. 과학 (001~102)</option>
                    <option value="tech">Ⅳ. 기술 (001~100)</option>
                    <option value="art">Ⅴ. 예술 (001~047)</option>
                    <option value="mixed">Ⅵ. 복합 지문 (001~036)</option>
                    <option value="mock1">미니모의고사 1회 (01~17)</option>
                    <option value="mock2">미니모의고사 2회 (01~17)</option>
                </select>
            </div>
            <div>
                <label for="startQ" class="mb-1 ml-1 block text-xs font-black text-slate-400">시작 번호</label>
                <input id="startQ" type="number" inputmode="numeric" class="mono w-full border-2 border-slate-200 bg-slate-50 p-3 text-center text-lg font-black outline-none focus:border-blue-500" />
            </div>
            <div>
                <label for="endQ" class="mb-1 ml-1 block text-xs font-black text-slate-400">끝 번호</label>
                <input id="endQ" type="number" inputmode="numeric" class="mono w-full border-2 border-slate-200 bg-slate-50 p-3 text-center text-lg font-black outline-none focus:border-blue-500" />
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button id="btnBuild" type="button" class="bg-blue-600 px-3 py-3 text-sm font-black text-white hover:bg-blue-700">생성</button>
                <button id="btnClear" type="button" class="bg-slate-200 px-3 py-3 text-sm font-black text-slate-700 hover:bg-slate-300">초기화</button>
                <button id="btnGrade" type="button" class="bg-slate-900 px-3 py-3 text-sm font-black text-white hover:bg-black" disabled>채점</button>
            </div>
        </div>

        <p class="mt-4 text-xs font-bold text-slate-500">숫자 1~5 입력 시 자동 다음칸 이동, Enter 채점, 붙여넣기(예: 1234512...) 지원</p>
        <div id="question-list" class="mt-5 grid grid-cols-4 gap-2 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10"></div>

        <div id="summary" class="mt-5 hidden border border-blue-200 bg-blue-50 p-4 text-base font-black text-blue-900"></div>
        <div id="wrongWrap" class="mt-4 hidden border border-slate-200 bg-slate-50 p-4">
            <h2 class="text-sm font-black text-slate-600">오답 목록</h2>
            <div id="wrongList" class="mt-2 text-sm font-bold text-slate-700"></div>
        </div>
    </section>
</main>

<footer class="border-t border-slate-300 bg-[#d7d9de] py-6">
    <div class="mx-auto max-w-[1180px] px-4 text-center text-[44px] font-semibold tracking-tight text-[#36516b]">
        bmunhak.com
    </div>
</footer>

<script>
    const db = {
        "humanities": { 1:3, 2:1, 3:4, 4:4, 5:5, 6:4, 7:3, 8:1, 9:5, 10:5, 11:3, 12:1, 13:1, 14:3, 15:4, 16:1, 17:2, 18:3, 19:1, 20:3, 21:4, 22:3, 23:2, 24:3, 25:2, 26:4, 27:5, 28:5, 29:5, 30:3, 31:2, 32:3, 33:5, 34:2, 35:3, 36:1, 37:2, 38:1, 39:2, 40:2, 41:3, 42:4, 43:4, 44:4, 45:3, 46:3, 47:4, 48:4, 49:5, 50:1, 51:4, 52:5, 53:1, 54:4, 55:4, 56:5, 57:4, 58:1, 59:1, 60:2, 61:2, 62:4, 63:5, 64:5, 65:2, 66:5, 67:5, 68:3, 69:2, 70:1, 71:5, 72:1, 73:5, 74:5, 75:1, 76:5, 77:1, 78:4, 79:4, 80:5, 81:2, 82:4, 83:4, 84:1, 85:1, 86:2, 87:2, 88:4, 89:5, 90:2, 91:1, 92:2, 93:3, 94:4, 95:4, 96:1, 97:5, 98:3, 99:1, 100:3, 101:1, 102:2, 103:3, 104:4, 105:5, 106:4, 107:5, 108:4, 109:5, 110:1, 111:1, 112:4, 113:3, 114:3, 115:5, 116:1, 117:1, 118:4, 119:5, 120:3, 121:2, 122:4, 123:5, 124:3, 125:2, 126:1, 127:2, 128:4, 129:5, 130:3, 131:5, 132:5, 133:1, 134:4, 135:5, 136:3, 137:2, 138:5, 139:2, 140:3, 141:4, 142:4, 143:2, 144:2, 145:1, 146:1, 147:4, 148:5, 149:3, 150:4, 151:3, 152:1, 153:4, 154:2, 155:4, 156:5, 157:4, 158:2, 159:4, 160:3, 161:3, 162:2, 163:5, 164:4, 165:5, 166:5, 167:4, 168:2, 169:4, 170:1, 171:4, 172:5, 173:3, 174:4, 175:5, 176:4, 177:5, 178:2, 179:5, 180:2, 181:2, 182:5, 183:3, 184:1, 185:2, 186:3, 187:3, 188:2, 189:5, 190:1, 191:4, 192:5, 193:1, 194:1, 195:4, 196:1, 197:1, 198:5, 199:4, 200:2, 201:5, 202:1, 203:1, 204:3, 205:5, 206:5, 207:1, 208:3, 209:4, 210:4, 211:5, 212:4, 213:3 },
        "social": { 1:1, 2:5, 3:4, 4:2, 5:2, 6:5, 7:5, 8:4, 9:1, 10:3, 11:4, 12:5, 13:5, 14:3, 15:2, 16:4, 17:2, 18:3, 19:1, 20:3, 21:4, 22:3, 23:2, 24:5, 25:4, 26:3, 27:3, 28:4, 29:3, 30:1, 31:3, 32:2, 33:1, 34:5, 35:1, 36:4, 37:3, 38:2, 39:1, 40:5, 41:1, 42:5, 43:4, 44:3, 45:5, 46:4, 47:5, 48:2, 49:2, 50:3, 51:1, 52:3, 53:5, 54:4, 55:1, 56:4, 57:5, 58:2, 59:5, 60:5, 61:1, 62:5, 63:4, 64:3, 65:3, 66:2, 67:1, 68:3, 69:5, 70:3, 71:4, 72:5, 73:1, 74:4, 75:1, 76:5, 77:1, 78:5, 79:5, 80:2, 81:1, 82:3, 83:5, 84:2, 85:4, 86:5, 87:4, 88:1, 89:1, 90:4, 91:4, 92:4, 93:3, 94:1, 95:2, 96:4, 97:2, 98:4, 99:5, 100:3, 101:1, 102:4, 103:2, 104:5, 105:5, 106:2, 107:3, 108:1, 109:3, 110:5, 111:1, 112:3, 113:1, 114:1, 115:2, 116:2, 117:3, 118:1, 119:5, 120:2, 121:1, 122:5, 123:3, 124:2, 125:2, 126:2, 127:4, 128:5, 129:5, 130:2, 131:3, 132:2, 133:1, 134:3, 135:5, 136:3, 137:5, 138:4, 139:2, 140:3, 141:4, 142:1, 143:1, 144:2, 145:3, 146:3, 147:3, 148:2, 149:4, 150:3, 151:3, 152:5, 153:3, 154:2, 155:3, 156:1, 157:1, 158:2, 159:1, 160:5, 161:1, 162:5, 163:4, 164:1, 165:2, 166:1, 167:5, 168:5, 169:3 },
        "science": { 1:5, 2:1, 3:3, 4:1, 5:5, 6:2, 7:4, 8:1, 9:3, 10:5, 11:3, 12:2, 13:5, 14:4, 15:2, 16:4, 17:5, 18:3, 19:3, 20:2, 21:5, 22:2, 23:4, 24:4, 25:5, 26:4, 27:5, 28:4, 29:3, 30:4, 31:5, 32:1, 33:5, 34:1, 35:4, 36:1, 37:3, 38:3, 39:2, 40:1, 41:4, 42:3, 43:1, 44:2, 45:4, 46:3, 47:5, 48:2, 49:5, 50:4, 51:4, 52:3, 53:4, 54:2, 55:1, 56:1, 57:5, 58:5, 59:2, 60:3, 61:1, 62:5, 63:2, 64:3, 65:4, 66:4, 67:1, 68:1, 69:2, 70:4, 71:2, 72:1, 73:2, 74:3, 75:3, 76:3, 77:4, 78:5, 79:2, 80:1, 81:4, 82:3, 83:1, 84:4, 85:2, 86:5, 87:4, 88:1, 89:3, 90:5, 91:1, 92:4, 93:3, 94:3, 95:3, 96:4, 97:2, 98:3, 99:3, 100:2, 101:5, 102:3 },
        "tech": { 1:3, 2:1, 3:5, 4:3, 5:4, 6:5, 7:2, 8:3, 9:2, 10:2, 11:4, 12:4, 13:2, 14:2, 15:5, 16:4, 17:4, 18:4, 19:3, 20:2, 21:5, 22:2, 23:3, 24:1, 25:2, 26:1, 27:3, 28:4, 29:3, 30:2, 31:3, 32:4, 33:4, 34:5, 35:1, 36:2, 37:3, 38:2, 39:5, 40:5, 41:1, 42:3, 43:5, 44:3, 45:3, 46:1, 47:3, 48:1, 49:3, 50:1, 51:5, 52:4, 53:5, 54:2, 55:2, 56:3, 57:1, 58:5, 59:4, 60:2, 61:1, 62:2, 63:2, 64:1, 65:4, 66:2, 67:4, 68:1, 69:5, 70:3, 71:1, 72:1, 73:2, 74:2, 75:2, 76:3, 77:5, 78:1, 79:2, 80:2, 81:2, 82:5, 83:5, 84:3, 85:3, 86:1, 87:5, 88:4, 89:4, 90:4, 91:2, 92:2, 93:3, 94:3, 95:4, 96:3, 97:2, 98:1, 99:5, 100:3 },
        "art": { 1:1, 2:3, 3:5, 4:1, 5:5, 6:1, 7:1, 8:5, 9:3, 10:2, 11:1, 12:4, 13:4, 14:1, 15:1, 16:4, 17:3, 18:3, 19:3, 20:3, 21:5, 22:4, 23:1, 24:3, 25:3, 26:5, 27:5, 28:4, 29:1, 30:1, 31:2, 32:3, 33:3, 34:5, 35:4, 36:1, 37:4, 38:2, 39:5, 40:4, 41:5, 42:4, 43:1, 44:3, 45:4, 46:4, 47:1 },
        "mixed": { 1:2, 2:5, 3:4, 4:1, 5:2, 6:4, 7:4, 8:3, 9:1, 10:5, 11:2, 12:4, 13:2, 14:5, 15:4, 16:5, 17:2, 18:2, 19:5, 20:4, 21:2, 22:1, 23:4, 24:3, 25:3, 26:4, 27:2, 28:5, 29:5, 30:3, 31:4, 32:1, 33:4, 34:3, 35:2, 36:4 },
        "mock1": { 1:4, 2:2, 3:1, 4:4, 5:1, 6:1, 7:3, 8:5, 9:2, 10:1, 11:5, 12:1, 13:1, 14:5, 15:4, 16:1, 17:5 },
        "mock2": { 1:5, 2:4, 3:1, 4:2, 5:1, 6:4, 7:2, 8:2, 9:1, 10:3, 11:3, 12:4, 13:1, 14:5, 15:1, 16:4, 17:1 }
    };

    const subjectSelect = document.getElementById('subjectSelect');
    const startQ = document.getElementById('startQ');
    const endQ = document.getElementById('endQ');
    const statusMsg = document.getElementById('statusMsg');
    const questionList = document.getElementById('question-list');
    const summary = document.getElementById('summary');
    const wrongWrap = document.getElementById('wrongWrap');
    const wrongList = document.getElementById('wrongList');
    const btnBuild = document.getElementById('btnBuild');
    const btnClear = document.getElementById('btnClear');
    const btnGrade = document.getElementById('btnGrade');
    const btnMenu = document.getElementById('btnMenu');
    const mobileMenu = document.getElementById('mobileMenu');

    let questionIds = [];
    let gradeBusy = false;

    function getSubjectRange(subject) {
        const keys = Object.keys(db[subject] || {}).map(Number).sort((a, b) => a - b);
        return {
            min: keys[0] || 1,
            max: keys[keys.length - 1] || 1
        };
    }

    function setDefaultRange() {
        const { min, max } = getSubjectRange(subjectSelect.value);
        startQ.value = String(min);
        endQ.value = String(max);
    }

    function setStatus(message) {
        statusMsg.textContent = message;
    }

    async function getAuthedUser() {
        const app = window.JungdapApp || null;
        const sbClient = typeof app?.getSb === "function" ? app.getSb() : null;
        if (!sbClient?.auth) {
            alert("로그인 모듈이 아직 준비되지 않았습니다. 잠시 후 다시 시도해주세요.");
            return null;
        }

        const [{ data: sessionData }, { data: userData, error: userError }] = await Promise.all([
            sbClient.auth.getSession(),
            sbClient.auth.getUser()
        ]);

        const accessToken = sessionData?.session?.access_token || "";
        const user = userData?.user || null;
        if (userError || !user || !accessToken) {
            if (typeof app?.openAuth === "function") app.openAuth("login");
            setStatus("로그인이 필요합니다.");
            return null;
        }

        return { user, accessToken };
    }

    function buildAnswerPayload() {
        const payload = {};
        for (const qNum of questionIds) {
            const input = document.getElementById(`q-${qNum}`);
            if (!input) continue;
            const value = Number.parseInt(input.value, 10);
            if (!Number.isFinite(value) || value < 1 || value > 5) continue;
            payload[qNum] = value;
        }
        return payload;
    }

    async function submitServerGrade({ year, subject, startQ, endQ, answers, userId, accessToken }) {
        const res = await fetch("/.netlify/functions/grade-mothertung", {
            method: "POST",
            headers: {
                "content-type": "application/json",
                authorization: `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                year,
                subject,
                startQ,
                endQ,
                answers,
                user_id: userId
            })
        });

        const payload = await res.json().catch(() => ({}));
        if (!res.ok || !payload?.ok) {
            const message = payload?.detail || payload?.error || `HTTP_${res.status}`;
            throw new Error(String(message));
        }
        return payload;
    }

    function resetAll(message = "범위를 설정하고 생성 버튼을 눌러주세요.") {
        questionIds = [];
        questionList.innerHTML = "";
        wrongList.innerHTML = "";
        summary.classList.add('hidden');
        wrongWrap.classList.add('hidden');
        btnGrade.disabled = true;
        setStatus(message);
    }

    function clampRange(start, end, min, max) {
        const safeStart = Math.min(Math.max(start, min), max);
        const safeEnd = Math.min(Math.max(end, min), max);
        if (safeStart > safeEnd) return null;
        return { start: safeStart, end: safeEnd };
    }

    function inputByPos(pos) {
        const qid = questionIds[pos];
        if (!qid) return null;
        return document.getElementById(`q-${qid}`);
    }

    function focusPos(pos) {
        const target = inputByPos(pos);
        if (target) target.focus();
    }

    function focusNext(pos) {
        for (let next = pos + 1; next < questionIds.length; next++) {
            if (inputByPos(next)) {
                focusPos(next);
                return;
            }
        }
    }

    function focusPrev(pos) {
        for (let prev = pos - 1; prev >= 0; prev--) {
            if (inputByPos(prev)) {
                focusPos(prev);
                return;
            }
        }
    }

    function clearVisualState(input, mark) {
        input.classList.remove("border-green-500", "bg-green-50", "border-red-500", "bg-red-50", "border-amber-500", "bg-amber-50");
        input.classList.add("border-slate-200");
        mark.textContent = "·";
        mark.className = "mt-1 text-center text-xs font-black text-slate-300";
    }

    function applyResultState(input, mark, state) {
        input.classList.remove("border-slate-200", "border-green-500", "bg-green-50", "border-red-500", "bg-red-50", "border-amber-500", "bg-amber-50");
        if (state === "O") {
            input.classList.add("border-green-500", "bg-green-50");
            mark.textContent = "O";
            mark.className = "mt-1 text-center text-xs font-black text-green-600";
            return;
        }
        if (state === "X") {
            input.classList.add("border-red-500", "bg-red-50");
            mark.textContent = "X";
            mark.className = "mt-1 text-center text-xs font-black text-red-600";
            return;
        }
        input.classList.add("border-amber-500", "bg-amber-50");
        mark.textContent = "!";
        mark.className = "mt-1 text-center text-xs font-black text-amber-500";
    }

    function handleInputChange(event) {
        const input = event.target;
        const pos = Number(input.dataset.pos || -1);
        const qNum = Number(input.dataset.qnum || 0);
        const mark = document.getElementById(`res-${qNum}`);
        const value = input.value.trim();

        if (value === "") {
            clearVisualState(input, mark);
            return;
        }

        if (!/^[1-5]$/.test(value)) {
            input.value = "";
            clearVisualState(input, mark);
            return;
        }
        focusNext(pos);
    }

    function handleInputKeydown(event) {
        const input = event.target;
        const pos = Number(input.dataset.pos || -1);
        const value = input.value.trim();

        if (event.key === "Enter") {
            event.preventDefault();
            gradeExam();
            return;
        }
        if (event.key === "Backspace" && value === "") {
            event.preventDefault();
            focusPrev(pos);
            return;
        }
        if (event.key === "ArrowLeft" || event.key === "ArrowUp") {
            event.preventDefault();
            focusPrev(pos);
            return;
        }
        if (event.key === "ArrowRight" || event.key === "ArrowDown") {
            event.preventDefault();
            focusNext(pos);
            return;
        }
        if (event.key.length === 1 && !/[1-5]/.test(event.key)) {
            event.preventDefault();
        }
    }

    function handlePaste(event) {
        const input = event.target;
        const startPos = Number(input.dataset.pos || -1);
        const digits = (event.clipboardData?.getData("text") || "")
            .replace(/\s+/g, "")
            .split("")
            .filter((ch) => /[1-5]/.test(ch));

        if (!digits.length) return;

        event.preventDefault();
        let pos = startPos;
        for (const digit of digits) {
            const target = inputByPos(pos);
            if (!target) break;
            target.value = digit;
            const mark = document.getElementById(`res-${target.dataset.qnum}`);
            clearVisualState(target, mark);
            pos += 1;
        }
        focusPos(Math.min(pos, questionIds.length - 1));
    }

    function createInputs() {
        const subject = subjectSelect.value;
        const { min, max } = getSubjectRange(subject);
        const start = parseInt(startQ.value, 10);
        const end = parseInt(endQ.value, 10);
        if (Number.isNaN(start) || Number.isNaN(end)) {
            alert("시작 번호와 끝 번호를 입력해주세요.");
            return;
        }

        const range = clampRange(start, end, min, max);
        if (!range) {
            alert(`범위는 ${min}번부터 ${max}번까지 설정할 수 있습니다.`);
            return;
        }

        startQ.value = String(range.start);
        endQ.value = String(range.end);
        questionIds = [];
        questionList.innerHTML = "";
        summary.classList.add("hidden");
        wrongWrap.classList.add("hidden");
        wrongList.innerHTML = "";

        for (let q = range.start, pos = 0; q <= range.end; q += 1, pos += 1) {
            questionIds.push(q);
            const box = document.createElement("div");
            box.className = "border border-slate-200 bg-white p-2";
            box.innerHTML = `
                <div class="mono text-center text-xs font-black text-slate-400">${String(q).padStart(3, "0")}</div>
                <input id="q-${q}" data-qnum="${q}" data-pos="${pos}" type="text" inputmode="numeric" maxlength="1"
                    class="mono mt-1 w-full border-2 border-slate-200 bg-slate-50 p-2 text-center text-lg font-black outline-none focus:border-blue-500" />
                <div id="res-${q}" class="mt-1 text-center text-xs font-black text-slate-300">·</div>
            `;

            const input = box.querySelector("input");
            const mark = box.querySelector(`#res-${q}`);
            input.addEventListener("input", handleInputChange);
            input.addEventListener("keydown", handleInputKeydown);
            input.addEventListener("paste", handlePaste);
            clearVisualState(input, mark);
            questionList.appendChild(box);
        }

        btnGrade.disabled = false;
        setStatus(`${range.start}번부터 ${range.end}번까지 생성 완료`);
        focusPos(0);
    }

    function clearInputs() {
        for (const qNum of questionIds) {
            const input = document.getElementById(`q-${qNum}`);
            const mark = document.getElementById(`res-${qNum}`);
            if (!input || !mark) continue;
            input.value = "";
            clearVisualState(input, mark);
        }
        summary.classList.add("hidden");
        wrongWrap.classList.add("hidden");
        wrongList.innerHTML = "";
        setStatus("입력을 초기화했습니다.");
        focusPos(0);
    }

    async function gradeExam() {
        if (!questionIds.length || gradeBusy) return;

        const auth = await getAuthedUser();
        if (!auth) return;
        const { user, accessToken } = auth;

        const subject = subjectSelect.value;
        const answerDB = db[subject] || {};
        let correct = 0;
        let attempted = 0;
        let unanswered = 0;
        const wrongRows = [];

        for (const qNum of questionIds) {
            const input = document.getElementById(`q-${qNum}`);
            const mark = document.getElementById(`res-${qNum}`);
            const userValue = parseInt(input.value, 10);
            const correctValue = answerDB[qNum];

            if (!userValue) {
                unanswered += 1;
                applyResultState(input, mark, "!");
                continue;
            }

            attempted += 1;
            if (userValue === correctValue) {
                correct += 1;
                applyResultState(input, mark, "O");
            } else {
                applyResultState(input, mark, "X");
                wrongRows.push(`${String(qNum).padStart(3, "0")}번: 내 답 ${userValue} / 정답 ${correctValue}`);
            }
        }

        const wrong = attempted - correct;
        summary.textContent = `${attempted}문제 채점 · ${correct}정답 · ${wrong}오답 · ${unanswered}미입력`;
        summary.classList.remove("hidden");
        if (wrongRows.length) {
            wrongList.innerHTML = wrongRows.map((row) => `<div>${row}</div>`).join("");
            wrongWrap.classList.remove("hidden");
        } else {
            wrongWrap.classList.add("hidden");
            wrongList.innerHTML = "";
        }

        gradeBusy = true;
        btnGrade.disabled = true;
        setStatus("서버 채점/저장 중...");

        try {
            const payload = await submitServerGrade({
                year: 2026,
                subject,
                startQ: questionIds[0],
                endQ: questionIds[questionIds.length - 1],
                answers: buildAnswerPayload(),
                userId: user.id,
                accessToken
            });

            const s = payload.summary || {};
            const total = Number(s.total || 0);
            const serverAttempted = Number(s.attempted || 0);
            const serverCorrect = Number(s.correct || 0);
            const serverWrong = Number(s.wrong || 0);
            const serverUnanswered = Number(s.unanswered || 0);
            const attemptId = payload.attempt_id;
            const recordHref = `/records.html?year=2026&section=${encodeURIComponent(subject)}`;
            summary.innerHTML = `
                ${serverAttempted}문제 채점 · ${serverCorrect}정답 · ${serverWrong}오답 · ${serverUnanswered}미입력 (총 ${total}문항)
                <div class="mt-1 text-sm">
                    저장 완료 (시도 #${attemptId})
                    <a href="${recordHref}" class="ml-2 underline">기록 보기</a>
                </div>
            `;
            setStatus("채점 및 저장 완료");
        } catch (error) {
            console.error("[grader] grade-mothertung failed:", error);
            setStatus("로컬 채점 완료 · 서버 저장 실패");
            alert(`서버 채점/저장에 실패했습니다: ${String(error?.message || error)}`);
        } finally {
            gradeBusy = false;
            btnGrade.disabled = false;
        }
    }

    btnBuild.addEventListener("click", createInputs);
    btnClear.addEventListener("click", clearInputs);
    btnGrade.addEventListener("click", gradeExam);
    subjectSelect.addEventListener("change", () => {
        setDefaultRange();
        resetAll("과목이 바뀌어 범위를 다시 맞췄습니다.");
    });
    endQ.addEventListener("keydown", (event) => {
        if (event.key === "Enter") createInputs();
    });
    btnMenu.addEventListener("click", () => {
        mobileMenu.classList.toggle("hidden");
    });

    setDefaultRange();
    resetAll();
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/app.js?v=20260226-1"></script>

</body>
</html>

