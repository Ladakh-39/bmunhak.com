<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸€ ë³´ê¸° | jungdap.com</title>
  <link rel="icon" href="/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT@2/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet" />
  <style>
    :root {
      --jd-header: #7092BE;
    }
    body {
      font-family: "SUIT Variable", -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      background: #ededed;
      color: #111827;
    }
    .hc-shell {
      max-width: 1440px;
      margin: 0 auto;
      padding: 0 16px;
    }
    .jd-card {
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 0;
      box-shadow: none;
    }
    .mono { font-variant-numeric: tabular-nums; }
    .section-tag {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 4px 11px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid transparent;
      line-height: 1;
    }
    .section-tag.notice  { background: #e8e7ee; border-color: #d0cedb; color: #4a4665; }
    .section-tag.welcome { background: #f1e4ea; border-color: #dec2d0; color: #76415c; }
    .section-tag.free    { background: #e3edf2; border-color: #c4d6e0; color: #35566a; }
    .section-tag.study   { background: #f3ebdf; border-color: #dcc9ad; color: #745537; }
    .section-tag.review  { background: #eceedc; border-color: #d3d6b2; color: #68682b; }
    .section-tag.gallery { background: #e5e7f5; border-color: #c7cce5; color: #3b457d; }
    .section-tag.lang    { background: #dce9eb; border-color: #bdd4d8; color: #2f5a62; }
    .section-tag.logic   { background: #deebf3; border-color: #c2d8e8; color: #355f7c; }
    .section-tag.howto   { background: #e6eef5; border-color: #cddce9; color: #406179; }
    .prefix-tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 92px;
      height: 26px;
      flex: 0 0 92px;
      border-radius: 999px;
      padding: 0;
      font-size: 11px;
      font-weight: 900;
      border: 1px solid transparent;
      line-height: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: -0.02em;
    }
    .prefix-tag.notice { background: #f4dbe4; border-color: #e5c3d0; color: #7a304f; }
    .prefix-tag.study  { background: #f5e8d8; border-color: #e4cfb4; color: #7a5127; }
    .prefix-tag.review { background: #ece9d6; border-color: #d8d4b4; color: #6f6a29; }
    .prefix-tag.info   { background: #dceaf2; border-color: #c3dce8; color: #2c5f79; }
    .prefix-tag.qna    { background: #e8def3; border-color: #d4c3e8; color: #5e3f7d; }
    .prefix-tag.free   { background: #e3edf2; border-color: #c4d6e0; color: #35566a; }
    .prefix-tag.etc    { background: #ebebeb; border-color: #d8d8d8; color: #5f5f5f; }
    .post-body-html :where(h1, h2, h3) {
      font-weight: 900;
      margin: 18px 0 10px;
    }
    .post-body-html p {
      margin: 10px 0;
      line-height: 1.75;
      font-weight: 700;
    }
    .post-body-html a {
      color: #2563eb;
      text-decoration: underline;
      word-break: break-all;
    }
    .post-body-html ul,
    .post-body-html ol {
      margin: 10px 0;
      padding-left: 24px;
    }
    .comment-avatar {
      width: 42px;
      height: 42px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      overflow: hidden;
      background: #f1f5f9;
      flex: 0 0 auto;
    }
    .footer-logo {
      height: 86px;
      width: auto;
      display: block;
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="border-b border-slate-400 bg-[#7092BE] text-white overflow-hidden">
    <div class="hc-shell">
      <div class="flex h-16 items-center gap-4 overflow-hidden">
        <div class="flex items-center min-w-[160px]">
          <a href="/" class="block">
            <span class="block text-[34px] leading-none font-black tracking-tight text-[#33506a]">bmunhak</span>
          </a>
        </div>

        <nav class="hidden md:flex flex-1 items-center justify-center gap-5 text-[18px] leading-none min-w-0 flex-nowrap whitespace-nowrap">
          <span class="room-secret-slot inline-flex items-center justify-center w-[104px] whitespace-nowrap">
            <a id="room-of-requirement" href="/board.html?b=room" class="room-secret-prehide leading-none transition-colors whitespace-nowrap" style="visibility:hidden;pointer-events:none;">í•„ìš”ì˜ ë°©</a>
          </span>
          <a href="/board.html?b=notice" class="leading-none hover:underline whitespace-nowrap">ê³µì§€ì‚¬í•­</a>
          <a href="/board.html?b=intro" class="leading-none hover:underline whitespace-nowrap">ê°€ì…ì¸ì‚¬</a>
          <a href="/board.html?b=free" class="leading-none hover:underline whitespace-nowrap">ììœ ê²Œì‹œíŒ</a>
          <a href="/board.html?b=qna" class="leading-none hover:underline whitespace-nowrap">ì§ˆë¬¸</a>
          <a href="/grader.html" class="leading-none hover:underline whitespace-nowrap">ì±„ì í•˜ê¸°</a>
          <a href="/my.html" class="leading-none hover:underline whitespace-nowrap">My Page</a>
        </nav>

        <div class="hidden md:flex items-center justify-end gap-3 min-w-[140px] text-sm font-semibold">
          <button id="btnSignupTop" type="button" class="hover:underline">íšŒì›ê°€ì…</button>
          <button id="btnLoginTop" type="button" class="hover:underline">ë¡œê·¸ì¸</button>
          <span id="welcomeText" class="hidden text-sm font-bold"></span>
          <button id="btnLogoutTop" type="button" class="hidden hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <button id="btnMobileMenu" class="md:hidden px-3 py-2 rounded-lg hover:bg-white/10" type="button" aria-label="menu">
          â˜°
        </button>
      </div>

      <div id="mobileMenu" class="md:hidden hidden pb-3">
        <div class="flex flex-col gap-2 text-base font-bold">
          <a id="room-of-requirement-mobile" href="/board.html?b=room" class="room-secret-prehide hidden px-3 py-2 rounded-lg transition-colors" style="visibility:hidden;pointer-events:none;">í•„ìš”ì˜ ë°©</a>
          <a href="/board.html?b=notice" class="px-3 py-2 rounded-lg hover:bg-white/10">ê³µì§€ì‚¬í•­</a>
          <a href="/board.html?b=intro" class="px-3 py-2 rounded-lg hover:bg-white/10">ê°€ì…ì¸ì‚¬</a>
          <a href="/board.html?b=free" class="px-3 py-2 rounded-lg hover:bg-white/10">ììœ ê²Œì‹œíŒ</a>
          <a href="/board.html?b=qna" class="px-3 py-2 rounded-lg hover:bg-white/10">ì§ˆë¬¸</a>
          <a href="/grader.html" class="px-3 py-2 rounded-lg hover:bg-white/10">ì±„ì í•˜ê¸°</a>
          <a href="/my.html" class="px-3 py-2 rounded-lg hover:bg-white/10">My Page</a>

          <div class="flex items-center gap-3 px-3 pt-2">
            <button id="btnSignupMobile" class="hover:underline" type="button">íšŒì›ê°€ì…</button>
            <button id="btnLoginMobile" class="hover:underline" type="button">ë¡œê·¸ì¸</button>
            <button id="btnLogoutMobile" class="hidden hover:underline" type="button">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="hc-shell py-6">
    <div id="authGateNotice" class="hidden bg-white border border-slate-300 mb-4 p-4">
      <div class="text-sm font-black text-slate-800">í•„ìš”ì˜ ë°© ê¸€ì€ ë¡œê·¸ì¸ ë° ìŠ¹ì¸ëœ ê³„ì •ë§Œ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      <div class="mt-2 text-xs font-bold text-slate-500">ë¡œê·¸ì¸ í›„ì—ë„ ì ‘ê·¼ì´ ì•ˆ ë˜ë©´ ìš´ì˜ìê°€ ìŠ¹ì¸(room_access_grants)ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.</div>
      <div class="mt-3 flex items-center gap-2">
        <button id="authGateLoginBtn" class="px-4 py-2 border border-slate-300 bg-slate-900 text-white text-sm font-black hover:bg-black">ë¡œê·¸ì¸</button>
        <button id="authGateSignupBtn" class="px-4 py-2 border border-slate-300 bg-white text-sm font-black hover:bg-slate-100">íšŒì›ê°€ì…</button>
      </div>
    </div>

    <div class="mb-4 flex items-center justify-between gap-3">
      <a id="backToList" href="/board.html?b=free" class="text-sm font-black text-slate-600 hover:underline">â† ëª©ë¡</a>
      <div class="flex items-center gap-2">
        <a id="btnEdit" href="#" class="hidden px-4 py-2 border border-slate-300 bg-white font-black hover:bg-slate-100">ìˆ˜ì •</a>
        <button id="btnDelete" class="hidden px-4 py-2 border border-rose-300 bg-rose-50 text-rose-700 font-black hover:bg-rose-100">ì‚­ì œ</button>
      </div>
    </div>

    <article class="jd-card p-6">
      <div class="flex items-center gap-2 mb-3">
        <span id="sectionTag" class="section-tag free">ììœ ê²Œì‹œíŒ</span>
        <span id="prefixTag" class="prefix-tag notice hidden">ê³µì§€</span>
        <span id="postNo" class="mono text-xs font-black text-slate-400"></span>
      </div>
      <h1 id="postTitle" class="text-[26px] leading-[1.05] font-extrabold text-slate-900 tracking-tight">ë¡œë”© ì¤‘...</h1>
      <div class="mt-3 text-xs md:text-sm font-bold text-slate-500 flex flex-wrap gap-x-4 gap-y-1">
        <span>ì‘ì„±ì: <span id="postAuthor" class="text-slate-700">-</span></span>
        <span>ì‘ì„±ì¼: <span id="postDate" class="mono">-</span></span>
        <span>ì¡°íšŒ: <span id="postViews" class="mono">0</span></span>
        <span>ì¶”ì²œ: <span id="postLikes" class="mono">0</span></span>
        <span>ë¹„ì¶”ì²œ: <span id="postDislikes" class="mono">0</span></span>
        <span>ëŒ“ê¸€: <span id="postComments" class="mono">0</span></span>
      </div>
      <div id="postLinks" class="hidden mt-4 border border-slate-200 bg-slate-50 p-3">
        <div class="text-xs font-black text-slate-500 mb-2">ë§í¬</div>
        <div id="postLinksList" class="grid gap-1 text-sm font-bold"></div>
      </div>
      <div id="postFiles" class="hidden mt-4 border border-slate-200 bg-slate-50 p-3">
        <div class="text-xs font-black text-slate-500 mb-2">ì²¨ë¶€íŒŒì¼</div>
        <div id="postFilesList" class="grid gap-1 text-sm font-bold text-slate-700"></div>
      </div>
      <hr class="my-5 border-slate-200" />
      <div id="postHiddenNotice" class="hidden border border-rose-200 bg-rose-50 p-4 text-sm font-black text-rose-700">
        ì‹ ê³  ëˆ„ì ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬ëœ ê¸€ì…ë‹ˆë‹¤.
      </div>
      <div id="postBody" class="whitespace-pre-wrap leading-relaxed font-bold text-slate-800"></div>
      <div id="postActionsBar" class="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border-t border-slate-200 pt-4">
        <div class="flex items-center gap-2">
          <button id="btnLike" aria-label="ì¶”ì²œ" class="px-4 py-2 border border-slate-300 bg-white font-black hover:bg-slate-50">ğŸ‘ 0</button>
          <button id="btnDislike" class="px-4 py-2 border border-slate-300 bg-white font-black hover:bg-slate-50">ğŸ‘ 0</button>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnScrap" class="px-4 py-2 border border-slate-300 bg-white font-black hover:bg-slate-50 hidden">ìŠ¤í¬ë©</button>
          <button id="btnReport" class="px-4 py-2 border border-rose-300 bg-rose-50 text-rose-700 font-black hover:bg-rose-100">ì‹ ê³ </button>
        </div>
      </div>
      <div id="voteMsg" class="hidden mt-2 text-xs font-black text-rose-600"></div>
      <div id="reportMsg" class="hidden mt-1 text-xs font-black text-rose-600"></div>
    </article>

    <section class="mt-4 jd-card p-4">
      <div class="grid gap-2 text-sm font-bold">
        <a id="prevPostLink" href="#" class="hidden text-slate-700 hover:underline"></a>
        <a id="nextPostLink" href="#" class="hidden text-slate-700 hover:underline"></a>
      </div>
      <div class="mt-3 flex justify-end">
        <a id="listNavBtn" href="/board.html?b=free" class="px-4 py-2 border border-slate-300 bg-white font-black hover:bg-slate-50">ëª©ë¡</a>
      </div>
    </section>

    <section class="mt-6 jd-card p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-[26px] leading-[1.05] font-extrabold text-slate-900">ëŒ“ê¸€</h2>
        <span id="commentCountLabel" class="text-xs font-black text-slate-400"></span>
      </div>
      <div id="commentList" class="grid gap-3"></div>
      <div class="mt-4 border-t border-slate-200 pt-4">
        <label for="commentBody" class="block text-sm font-black text-slate-700 mb-2">ëŒ“ê¸€ ì‘ì„±</label>
        <textarea id="commentBody" rows="3" class="w-full p-3 border border-slate-300 bg-white font-bold" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <div class="mt-2 flex items-center justify-between gap-2">
          <label class="inline-flex items-center gap-2 text-sm font-black text-slate-600 cursor-pointer">
            <input id="commentImageInput" type="file" accept="image/*" class="hidden" />
            ì‚¬ì§„
          </label>
          <span id="commentImageLabel" class="text-xs font-bold text-slate-500">ì‚¬ì§„ ì—†ìŒ</span>
        </div>
        <div class="mt-2 flex items-center justify-between">
          <div id="commentMsg" class="text-sm font-black text-rose-600 hidden"></div>
          <button id="btnAddComment" class="hidden px-4 py-2 border border-[#445394] bg-[#5467AC] text-white font-black hover:brightness-110">ëŒ“ê¸€ì“°ê¸°</button>
        </div>
      </div>
    </section>

    <section id="authorRecentSection" class="mt-6 jd-card p-6 hidden">
      <h2 class="text-[26px] leading-[1.05] font-extrabold text-slate-900"><span id="authorRecentName" class="font-black"></span>ë‹˜ì˜ ìµœê·¼ ê²Œì‹œë¬¼</h2>
      <div id="authorRecentList" class="mt-3 grid gap-2 text-sm font-bold text-slate-700"></div>
    </section>

    <section class="mt-6 jd-card p-6">
      <h2 class="text-[26px] leading-[1.05] font-extrabold text-slate-900">ëª©ë¡</h2>
      <div class="mt-3 overflow-x-auto border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr class="text-slate-500 font-black">
              <th class="px-3 py-3 text-left w-[80px]">ë²ˆí˜¸</th>
              <th class="px-3 py-3 text-left">ì œëª©</th>
              <th class="px-3 py-3 text-left w-[120px]">ì‘ì„±ì</th>
              <th class="px-3 py-3 text-left w-[100px]">ë‚ ì§œ</th>
              <th class="px-3 py-3 text-right w-[80px]">ì¡°íšŒ</th>
              <th class="px-3 py-3 text-right w-[80px]">ì¶”ì²œ</th>
            </tr>
          </thead>
          <tbody id="boardListTbody" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="mt-8 border-t border-slate-300 bg-[#efefef] py-8">
    <div class="hc-shell">
      <div class="grid grid-cols-1 md:grid-cols-3 items-end gap-6 text-sm font-bold text-slate-600">
        <div class="flex items-center justify-center md:justify-start gap-4 md:self-end">
          <button id="btnContactOpen" class="hover:underline">ë¬¸ì˜</button>
          <a href="/terms.html" class="hover:underline">ì´ìš©ì•½ê´€</a>
          <a href="/privacy.html" class="hover:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        </div>
        <div class="flex justify-center md:self-end">
          <a href="/" class="block">
            <span class="block text-[44px] leading-none font-black tracking-tight text-slate-700">bmunhak.com</span>
          </a>
        </div>
        <div class="flex items-center justify-center md:justify-end gap-3 md:self-end">
          <img src="/assets/kakao-qr.png" alt="kakao qr" class="h-14 w-14 border border-slate-300 bg-white p-1" />
          <button id="btnCopyKakaoLink" class="px-3 py-1 border border-slate-300 bg-white hover:bg-slate-100">ë§í¬ë³µì‚¬</button>
        </div>
      </div>
    </div>
  </footer>

  <div id="contactModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 p-4 z-[60]">
    <div class="w-full max-w-lg bg-white border border-slate-300 p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-black text-slate-900">ë¬¸ì˜í•˜ê¸°</h3>
        <button id="btnCloseContact" class="px-3 py-1 border border-slate-300 hover:bg-slate-100">ë‹«ê¸°</button>
      </div>
      <div class="grid gap-4">
        <p class="text-sm font-bold text-slate-600">ì•„ë˜ QR ë˜ëŠ” ë§í¬ ë³µì‚¬ë¡œ ì˜¤í”ˆì±„íŒ…ì— ì ‘ì†í•´ ì£¼ì„¸ìš”.</p>
        <div class="flex flex-col sm:flex-row items-center gap-4">
          <img src="/assets/kakao-qr.png" alt="kakao qr large" class="h-44 w-44 border border-slate-300 bg-white p-2" />
          <div class="grid gap-2 w-full">
            <button id="btnCopyKakaoLink2" class="px-3 py-2 border border-slate-300 bg-white font-black hover:bg-slate-100">ë§í¬ ë³µì‚¬</button>
            <div class="text-xs font-bold text-slate-500 break-all" id="kakaoLinkPreview"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="copyToast" class="fixed hidden items-center justify-center bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 bg-slate-900 text-white text-sm font-black z-[70]">ë³µì‚¬ë¨</div>

  <script>window.__bmunhakInlineAuthHandled = true;</script>
  <script src="/app.js?v=20260226-1"></script>
  <script>
    const APP = window.JungdapApp;
    const sbClient = APP.getSb();
    const FILE_BUCKET = "board-uploads";
    const MAX_FILE_SIZE = 4 * 1024 * 1024;

    const SECTION_META = {
      notice: { name: "ê³µì§€ì‚¬í•­", className: "notice" },
      welcome: { name: "ê°€ì…ì¸ì‚¬", className: "welcome" },
      free: { name: "ììœ ê²Œì‹œíŒ", className: "free" },
      study: { name: "ìŠ¤í„°ë”” ëª¨ì§‘", className: "study" },
      review: { name: "ì‹œí—˜í›„ê¸°", className: "review" },
      lang: { name: "ì–¸ì–´ì´í•´", className: "lang" },
      logic: { name: "ì¶”ë¦¬ë…¼ì¦", className: "logic" },
      room: { name: "í•„ìš”ì˜ ë°©", className: "free" }
    };
    const STUDY_REGION_PREFIXES = [
      "ê°•ì›", "ê²½ê¸°ë¶ë¶€", "ê²½ê¸°ë‚¨ë¶€", "ê²½ë‚¨", "ê²½ë¶", "ê´‘ì£¼", "ëŒ€êµ¬", "ëŒ€ì „", "ë¶€ì‚°",
      "ì„œìš¸ë™ë¶", "ì„œìš¸ì„œë¶", "ì„œìš¸ë™ë‚¨", "ì„œìš¸ì„œë‚¨", "ì„œìš¸ë„ì‹¬", "ì„¸ì¢…", "ìš¸ì‚°", "ì¸ì²œ",
      "ì „ë‚¨", "ì „ë¶", "ì œì£¼", "ì¶©ë‚¨", "ì¶©ë¶"
    ];
    const PREFIX_META = {
      notice: { label: "ê³µì§€", className: "notice" },
      "ê³µì§€": { label: "ê³µì§€", className: "notice" },
      study: { label: "ìŠ¤í„°ë”” ëª¨ì§‘", className: "study" },
      "ìŠ¤í„°ë”” ëª¨ì§‘": { label: "ìŠ¤í„°ë”” ëª¨ì§‘", className: "study" },
      review: { label: "ì‹œí—˜í›„ê¸°", className: "review" },
      "ì‹œí—˜í›„ê¸°": { label: "ì‹œí—˜í›„ê¸°", className: "review" },
      "ì •ë³´": { label: "ì •ë³´", className: "info" },
      "ì§ˆë¬¸": { label: "ì§ˆë¬¸", className: "qna" },
      "í•´ì„¤": { label: "í•´ì„¤", className: "info" },
      "í† ë¡ ": { label: "í† ë¡ ", className: "free" },
      "ìë£Œ": { label: "ìë£Œ", className: "info" },
      "ììœ ": { label: "ììœ ", className: "free" },
      "ê¸°íƒ€": { label: "ê¸°íƒ€", className: "etc" }
    };
    PREFIX_META["ìŠ¤í„°ë”” ëª¨ì§‘".replace(/\s+/g, "")] = PREFIX_META["ìŠ¤í„°ë”” ëª¨ì§‘"];
    for (const region of STUDY_REGION_PREFIXES) {
      PREFIX_META[region] = { label: region, className: "study" };
    }

    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const postId = Number(qs.get("id"));
    let currentUser = null;
    let currentPost = null;
    let viewTracked = false;
    let votePending = false;
    let reportPending = false;
    let isBoardAdmin = false;
    const postSchema = {
      authorDisplayAvailable: true,
      prefixAvailable: true,
      link1Available: true,
      link2Available: true,
      boardSeqAvailable: true
    };
    let profileMap = new Map();
    let profileNickname = "";
    let avatarPathAvailable = true;
    let commentParentAvailable = true;
    let commentImagePathAvailable = true;
    let commentLikeCountAvailable = true;
    let commentLikesTableReady = null;
    let commentLikeCountMap = new Map();
    let commentLikedByMe = new Set();
    let avatarPathMap = new Map();
    let avatarUrlMap = new Map();
    const MAX_COMMENT_RENDER_DEPTH = 12;

    function esc(input) {
      return APP.escapeHtml(input);
    }

    function setCommentMsg(message) {
      $("commentMsg").textContent = message;
      $("commentMsg").classList.remove("hidden");
    }
    function clearCommentMsg() {
      $("commentMsg").textContent = "";
      $("commentMsg").classList.add("hidden");
    }
    function setVoteMsg(message) {
      $("voteMsg").textContent = message;
      $("voteMsg").classList.remove("hidden");
    }
    function clearVoteMsg() {
      $("voteMsg").textContent = "";
      $("voteMsg").classList.add("hidden");
    }
    function setReportMsg(message) {
      $("reportMsg").textContent = message;
      $("reportMsg").classList.remove("hidden");
    }
    function clearReportMsg() {
      $("reportMsg").textContent = "";
      $("reportMsg").classList.add("hidden");
    }

    function scrubPostUI() {
      if ($("postTitle")) $("postTitle").textContent = "";
      if ($("postAuthor")) $("postAuthor").textContent = "-";
      if ($("postDate")) $("postDate").textContent = "-";
      if ($("postViews")) $("postViews").textContent = "0";
      if ($("postLikes")) $("postLikes").textContent = "0";
      if ($("postDislikes")) $("postDislikes").textContent = "0";
      if ($("postComments")) $("postComments").textContent = "0";
      if ($("postBody")) $("postBody").textContent = "";
      if ($("commentList")) $("commentList").innerHTML = "";
      if ($("commentCountLabel")) $("commentCountLabel").textContent = "";
      if ($("boardListTbody")) $("boardListTbody").innerHTML = "";
      $("authorRecentSection")?.classList.add("hidden");
      $("postFiles")?.classList.add("hidden");
      $("postLinks")?.classList.add("hidden");
      $("postHiddenNotice")?.classList.add("hidden");
      if ($("postFilesList")) $("postFilesList").innerHTML = "";
      if ($("postLinksList")) $("postLinksList").innerHTML = "";
      if ($("authorRecentList")) $("authorRecentList").innerHTML = "";
      clearVoteMsg();
      clearReportMsg();
      $("prevPostLink")?.classList.add("hidden");
      $("nextPostLink")?.classList.add("hidden");
      if ($("prevPostLink")) {
        $("prevPostLink").textContent = "";
        $("prevPostLink").removeAttribute("href");
      }
      if ($("nextPostLink")) {
        $("nextPostLink").textContent = "";
        $("nextPostLink").removeAttribute("href");
      }
    }

    function showAuthGatePost() {
      scrubPostUI();
      $("authGateNotice")?.classList.remove("hidden");
      APP.openAuth("login");
    }

    async function getProfileNicknameByUserId(uid) {
      if (!uid) return "";
      const { data } = await sbClient.from("profiles").select("nickname").eq("user_id", uid).maybeSingle();
      return String(data?.nickname || "").trim();
    }

    async function getMyDisplayName() {
      if (!currentUser) return "";
      if (profileNickname) return profileNickname;
      profileNickname = await getProfileNicknameByUserId(currentUser.id);
      if (profileNickname) return profileNickname;
      const local = String(currentUser.email || "").split("@")[0];
      return local || String(currentUser.id || "").slice(0, 8);
    }

    function isMissingParentIdError(error) {
      return APP.isMissingColumnError(error, "parent_id");
    }

    function isMissingImagePathError(error) {
      return APP.isMissingColumnError(error, "image_path");
    }

    function isMissingCommentLikeCountError(error) {
      return APP.isMissingColumnError(error, "like_count");
    }

    function isMissingAvatarPathError(error) {
      return APP.isMissingColumnError(error, "avatar_path");
    }

    function commentLikeLocalKey(commentId) {
      return `post_comment_like_${currentUser?.id || "guest"}_${commentId}`;
    }

    function isCommentLikedLocally(commentId) {
      if (!currentUser) return false;
      return localStorage.getItem(commentLikeLocalKey(commentId)) === "1";
    }

    function setCommentLikedLocally(commentId, liked) {
      if (!currentUser) return;
      if (liked) localStorage.setItem(commentLikeLocalKey(commentId), "1");
      else localStorage.removeItem(commentLikeLocalKey(commentId));
    }

    function buildCommentBody(rawBody, parentId, imagePath) {
      const tokens = [];
      if (Number.isFinite(Number(parentId)) && Number(parentId) > 0) tokens.push(`[[reply:${Number(parentId)}]]`);
      if (imagePath) tokens.push(`[[img:${String(imagePath)}]]`);
      const bodyText = String(rawBody || "").trim();
      return `${tokens.join(" ")}${tokens.length ? " " : ""}${bodyText}`.trim();
    }

    function parseCommentMeta(row) {
      let body = String(row?.body || "");
      let parentId = Number(row?.parent_id || 0);
      parentId = Number.isFinite(parentId) && parentId > 0 ? parentId : null;
      let imagePath = String(row?.image_path || "").trim();
      for (;;) {
        let matched = false;
        const replyMatch = body.match(/^\s*\[\[reply:(\d+)\]\]\s*/i);
        if (replyMatch) {
          if (!parentId) {
            const pid = Number(replyMatch[1]);
            parentId = Number.isFinite(pid) && pid > 0 ? pid : null;
          }
          body = body.slice(replyMatch[0].length);
          matched = true;
        }
        const imageMatch = body.match(/^\s*\[\[img:([^\]]+)\]\]\s*/i);
        if (imageMatch) {
          if (!imagePath) imagePath = imageMatch[1];
          body = body.slice(imageMatch[0].length);
          matched = true;
        }
        if (!matched) break;
      }
      return { body: body.trim(), parentId, imagePath };
    }

    async function validateCommentReplyTarget(parentId, expectedPostId) {
      const pid = Number(parentId || 0);
      if (!Number.isFinite(pid) || pid < 1) return { ok: true, parentId: null };

      let { data, error } = await sbClient
        .from("board_comments")
        .select("id,post_id,is_deleted")
        .eq("id", pid)
        .maybeSingle();

      if (error && APP.isMissingColumnError(error, "is_deleted")) {
        ({ data, error } = await sbClient
          .from("board_comments")
          .select("id,post_id")
          .eq("id", pid)
          .maybeSingle());
      }

      if (error) return { ok: false, message: error.message || "ë‹µê¸€ ëŒ€ìƒì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
      if (!data) return { ok: false, message: "ìœ íš¨í•˜ì§€ ì•Šì€ ë‹µê¸€ ëŒ€ìƒì…ë‹ˆë‹¤." };

      const parentPostId = Number(data.post_id || 0);
      if (!Number.isFinite(parentPostId) || parentPostId !== Number(expectedPostId)) {
        return { ok: false, message: "ë‹¤ë¥¸ ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ì—ëŠ” ë‹µê¸€ì„ ë‹¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
      }
      if (data.is_deleted === true) return { ok: false, message: "ì‚­ì œëœ ëŒ“ê¸€ì—ëŠ” ë‹µê¸€ì„ ë‹¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };

      return { ok: true, parentId: pid };
    }

    async function ensureCommentLikesTableReady() {
      commentLikesTableReady = false;
      return false;
    }

    async function loadProfileMap(ids) {
      const list = [...new Set((ids || []).filter(Boolean))];
      profileMap = new Map();
      avatarPathMap = new Map();
      avatarUrlMap = new Map();
      if (!list.length) return;

      const buildCols = () => {
        const cols = ["user_id", "nickname"];
        if (avatarPathAvailable) cols.push("avatar_path");
        return cols.join(",");
      };

      let { data, error } = await sbClient.from("profiles").select(buildCols()).in("user_id", list);
      if (error && avatarPathAvailable && isMissingAvatarPathError(error)) {
        avatarPathAvailable = false;
        ({ data, error } = await sbClient.from("profiles").select(buildCols()).in("user_id", list));
      }
      if (error) return;

      (data || []).forEach((row) => {
        const nick = String(row?.nickname || "").trim();
        if (row?.user_id && nick) profileMap.set(row.user_id, nick);
        const avatarPath = String(row?.avatar_path || "").trim();
        if (row?.user_id && avatarPath) avatarPathMap.set(row.user_id, avatarPath);
      });

      const paths = [...new Set([...avatarPathMap.values()])];
      const resolved = await Promise.all(paths.map(async (path) => {
        const url = await APP.resolveAvatarUrl(path);
        return [path, url];
      }));
      for (const [path, url] of resolved) {
        if (url) avatarUrlMap.set(path, url);
      }
    }

    function authorName(authorId, fallbackDisplay, isAnonymous = false) {
      if (isAnonymous || String(fallbackDisplay || "").trim() === "ìµëª…") return "ìµëª…";
      const nick = profileMap.get(authorId);
      if (nick) return nick;
      const display = String(fallbackDisplay || "").trim();
      if (display) return display;
      const id = String(authorId || "");
      return id ? id.slice(0, 8) : "-";
    }

    function authorAvatar(authorId) {
      const path = avatarPathMap.get(authorId);
      if (!path) return "";
      return avatarUrlMap.get(path) || "";
    }

    function isMissingAuthorDisplayError(error) {
      const msg = String(error?.message || "").toLowerCase();
      return msg.includes("author_display") && (msg.includes("does not exist") || msg.includes("schema cache"));
    }

    function isMissingPrefixError(error) {
      const msg = String(error?.message || "").toLowerCase();
      return msg.includes("prefix") && (msg.includes("does not exist") || msg.includes("schema cache"));
    }

    function isMissingLink1Error(error) {
      return APP.isMissingColumnError(error, "link1");
    }

    function isMissingLink2Error(error) {
      return APP.isMissingColumnError(error, "link2");
    }

    function isMissingBoardSeqError(error) {
      return APP.isMissingColumnError(error, "board_seq");
    }

    function isMissingBoardPostFilesTableError(error) {
      const msg = String(error?.message || "").toLowerCase();
      return msg.includes("board_post_files") && (msg.includes("does not exist") || msg.includes("schema cache"));
    }

    function applyNotDeletedFilter(query) {
      return query.eq("is_deleted", false);
    }

    async function detectBoardAdmin() {
      if (!currentUser) return false;
      const { data, error } = await sbClient.rpc("is_board_admin", { p_uid: currentUser.id });
      if (error) return false;
      return Boolean(data);
    }

    $("btnLoginTop")?.addEventListener("click", () => APP.openAuth("login"));
    $("btnSignupTop")?.addEventListener("click", () => APP.openAuth("signup"));

    $("btnLogoutTop")?.addEventListener("click", async () => {
      showAuthGatePost();
      try {
        await APP.hardSignOut(sbClient);
      } finally {
        location.replace("/?auth=login&needs_login=1");
      }
    });

    async function syncAuthUI(session) {
      currentUser = session?.user || null;
      const signedIn = Boolean(currentUser);
      $("welcomeText")?.classList.toggle("hidden", !signedIn);
      $("btnLogoutTop")?.classList.toggle("hidden", !signedIn);
      $("btnLoginTop")?.classList.toggle("hidden", signedIn);
      $("btnSignupTop")?.classList.toggle("hidden", signedIn);
      $("btnAddComment")?.classList.toggle("hidden", !signedIn);
      $("btnScrap")?.classList.toggle("hidden", !signedIn);
      if (signedIn) {
        profileNickname = await getProfileNicknameByUserId(currentUser.id);
        isBoardAdmin = await detectBoardAdmin();
        const viewName = await getMyDisplayName();
        if ($("welcomeText")) {
          $("welcomeText").textContent = `${viewName}ë‹˜`;
          $("welcomeText").style.color = "#212d2b";
        }
      } else {
        isBoardAdmin = false;
        if ($("welcomeText")) $("welcomeText").style.color = "";
      }
      applyOwnerButtons();
    }

    function canViewHiddenPost(post) {
      if (!post?.is_hidden) return true;
      const isOwner = Boolean(currentUser && post && currentUser.id === post.author_id);
      return isOwner || isBoardAdmin;
    }

    function applyOwnerButtons() {
      const isOwner = Boolean(currentUser && currentPost && currentUser.id === currentPost.author_id);
      const canManage = Boolean(isOwner || isBoardAdmin);
      $("btnEdit")?.classList.toggle("hidden", !isOwner);
      $("btnDelete")?.classList.toggle("hidden", !canManage);
      $("btnReport")?.classList.toggle("hidden", isOwner);
      if (isOwner && $("btnEdit")) $("btnEdit").href = `/write.html?edit=1&id=${currentPost.id}`;
    }

    function renderPostLinks(post) {
      const links = [String(post?.link1 || "").trim(), String(post?.link2 || "").trim()].filter(Boolean);
      if (!$("postLinks") || !$("postLinksList")) return;
      if (!links.length) {
        $("postLinks").classList.add("hidden");
        $("postLinksList").innerHTML = "";
        return;
      }
      $("postLinks").classList.remove("hidden");
      $("postLinksList").innerHTML = links.map((link, idx) => {
        const safe = esc(link);
        return `<a href="${safe}" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:underline break-all">Link #${idx + 1}: ${safe}</a>`;
      }).join("");
    }

    function sanitizeHtml(html) {
      if (!window.DOMPurify || typeof window.DOMPurify.sanitize !== "function") {
        return esc(html);
      }
      return window.DOMPurify.sanitize(String(html || ""));
    }

    function renderPostBody(post) {
      const bodyNode = $("postBody");
      if (!bodyNode) return;
      const text = String(post?.body || "");
      if (post?.is_html) {
        bodyNode.classList.remove("whitespace-pre-wrap");
        bodyNode.classList.add("post-body-html");
        bodyNode.innerHTML = sanitizeHtml(text);
        return;
      }
      bodyNode.classList.remove("post-body-html");
      bodyNode.classList.add("whitespace-pre-wrap");
      bodyNode.textContent = text;
    }

    function syncVoteButtons() {
      const like = Number(currentPost?.like_count || 0);
      const dislike = Number(currentPost?.dislike_count || 0);
      if ($("btnLike")) $("btnLike").textContent = `ğŸ‘ ${like}`;
      if ($("btnDislike")) $("btnDislike").textContent = `ğŸ‘ ${dislike}`;
    }

    function renderPost(post) {
      currentPost = post;
      const meta = SECTION_META[post.section_slug] || SECTION_META.free;
      const rawPrefix = String(post.prefix || "").trim();
      const compactPrefix = rawPrefix.replace(/\s+/g, "");
      const prefix = rawPrefix
        ? (PREFIX_META[rawPrefix] || PREFIX_META[compactPrefix] || { label: rawPrefix, className: "etc" })
        : null;
      if ($("sectionTag")) {
        $("sectionTag").textContent = meta.name;
        $("sectionTag").className = `section-tag ${meta.className}`;
      }
      if (prefix) {
        if ($("prefixTag")) {
          $("prefixTag").textContent = prefix.label;
          $("prefixTag").className = `prefix-tag ${prefix.className}`;
          $("prefixTag").classList.remove("hidden");
        }
      } else {
        $("prefixTag")?.classList.add("hidden");
      }
      const boardNo = Number(post?.board_seq || 0);
      const displayNo = Number.isFinite(boardNo) && boardNo > 0 ? boardNo : Number(post?.id || 0);
      if ($("postNo")) $("postNo").textContent = displayNo > 0 ? `#${displayNo}` : "";
      if ($("postTitle")) $("postTitle").textContent = post.title;
      if ($("postAuthor")) $("postAuthor").textContent = authorName(post.author_id, post.author_display, Boolean(post.is_anonymous));
      if ($("postDate")) $("postDate").textContent = new Date(post.created_at).toLocaleString("ko-KR");
      if ($("postViews")) $("postViews").textContent = String(post.view_count || 0);
      if ($("postLikes")) $("postLikes").textContent = String(post.like_count || 0);
      if ($("postDislikes")) $("postDislikes").textContent = String(post.dislike_count || 0);
      if ($("postComments")) $("postComments").textContent = String(post.comment_count || 0);
      syncVoteButtons();

      const canViewHidden = canViewHiddenPost(post);
      $("postHiddenNotice")?.classList.toggle("hidden", canViewHidden);
      if (canViewHidden) {
        renderPostLinks(post);
        renderPostBody(post);
      } else {
        $("postLinks")?.classList.add("hidden");
        if ($("postLinksList")) $("postLinksList").innerHTML = "";
        $("postFiles")?.classList.add("hidden");
        if ($("postBody")) $("postBody").textContent = "";
      }
      if ($("backToList")) $("backToList").href = `/board.html?b=${encodeURIComponent(post.section_slug)}`;
      if ($("listNavBtn")) $("listNavBtn").href = `/board.html?b=${encodeURIComponent(post.section_slug)}`;
      applyOwnerButtons();
    }

    async function trackPostViewOnce(post) {
      if (viewTracked || !post?.id) return;
      viewTracked = true;
      try {
        const { data: sessData } = await sbClient.auth.getSession();
        const accessToken = sessData?.session?.access_token;
        const headers = { "Content-Type": "application/json" };
        if (accessToken) headers.Authorization = `Bearer ${accessToken}`;
        const res = await fetch("/.netlify/functions/track-post-view", {
          method: "POST",
          headers,
          body: JSON.stringify({ post_id: post.id }),
        });
        const payload = await res.json().catch(() => null);
        if (res.ok && payload?.ok && Number.isFinite(Number(payload.view_count))) {
          const nextViews = Number(payload.view_count);
          $("postViews").textContent = String(nextViews);
          if (currentPost && currentPost.id === post.id) currentPost.view_count = nextViews;
        }
      } catch {
        // no-op
      }
    }

    async function loadPostFiles() {
      const wrap = $("postFiles");
      const list = $("postFilesList");
      wrap.classList.add("hidden");
      list.innerHTML = "";

      const { data, error } = await sbClient
        .from("board_post_files")
        .select("id,storage_path,filename,mime,size_bytes,created_at")
        .eq("post_id", postId)
        .order("id", { ascending: true });

      if (error) {
        if (isMissingBoardPostFilesTableError(error)) return;
        wrap.classList.remove("hidden");
        list.innerHTML = `<div class="text-rose-700">ì²¨ë¶€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${esc(error.message || "ì˜¤ë¥˜")}</div>`;
        return;
      }

      const rows = data || [];
      if (!rows.length) return;
      const htmlParts = [];
      for (const row of rows) {
        const mime = String(row.mime || "").toLowerCase();
        const isImage = mime.startsWith("image/");
        const url = await APP.resolveBoardUploadUrl(row.storage_path);
        const name = esc(row.filename || row.storage_path);
        const meta = `${APP.formatFileSize(row.size_bytes)}${row.mime ? ` Â· ${esc(row.mime)}` : ""}`;

        htmlParts.push(`<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:underline break-all">- ${name}</a>`);
        htmlParts.push(`<div class="text-xs text-slate-500 pl-3">${meta}</div>`);
        if (isImage && url) {
          htmlParts.push(`<img src="${url}" alt="${name}" class="mt-2 max-w-full rounded border" style="max-height:420px; object-fit:contain;" />`);
        } else if (isImage && !url) {
          htmlParts.push('<div class="text-xs font-bold text-slate-400 pl-3">ë¯¸ë¦¬ë³´ê¸° URL ìƒì„± ì‹¤íŒ¨</div>');
        }
      }

      wrap.classList.remove("hidden");
      list.innerHTML = htmlParts.join("");
    }

    async function loadPost() {
      if (!Number.isFinite(postId)) {
        $("postTitle").textContent = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.";
        return;
      }
      const buildSelectCols = () => {
        const cols = ["id", "section_slug", "author_id", "title", "body", "created_at", "view_count", "like_count", "dislike_count", "comment_count"];
        if (postSchema.boardSeqAvailable) cols.push("board_seq");
        if (postSchema.link1Available) cols.push("link1");
        if (postSchema.link2Available) cols.push("link2");
        if (postSchema.prefixAvailable) cols.push("prefix");
        if (postSchema.authorDisplayAvailable) cols.push("author_display");
        return cols.join(",");
      };

      let { data, error } = await applyNotDeletedFilter(
        sbClient
          .from("board_posts_active")
          .select(buildSelectCols())
          .eq("id", postId)
      ).maybeSingle();
      const missingAuthor = isMissingAuthorDisplayError(error);
      const missingPrefix = isMissingPrefixError(error);
      const missingLink1 = isMissingLink1Error(error);
      const missingLink2 = isMissingLink2Error(error);
      const missingBoardSeq = isMissingBoardSeqError(error);
      if (error && (
        (postSchema.authorDisplayAvailable && missingAuthor) ||
        (postSchema.prefixAvailable && missingPrefix) ||
        (postSchema.link1Available && missingLink1) ||
        (postSchema.link2Available && missingLink2) ||
        (postSchema.boardSeqAvailable && missingBoardSeq)
      )) {
        if (missingAuthor) postSchema.authorDisplayAvailable = false;
        if (missingPrefix) postSchema.prefixAvailable = false;
        if (missingLink1) postSchema.link1Available = false;
        if (missingLink2) postSchema.link2Available = false;
        if (missingBoardSeq) postSchema.boardSeqAvailable = false;
        ({ data, error } = await applyNotDeletedFilter(
          sbClient
            .from("board_posts_active")
            .select(buildSelectCols())
            .eq("id", postId)
        ).maybeSingle());
      }

      if (error) {
        const msg = String(error.message || "");
        const code = String(error.code || "");
        if (code === "42501" || msg.toLowerCase().includes("room_access_denied") || msg.toLowerCase().includes("permission denied")) {
          showAuthGatePost();
          return;
        }
        $("postTitle").textContent = "ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤(ì˜¤ë¥˜)";
        return;
      }

      if (!data) {
        $("postTitle").textContent = "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      await loadProfileMap([data.author_id]);
      renderPost(data);
      void trackPostViewOnce(data);
      const canViewHidden = canViewHiddenPost(data);
      const tasks = await Promise.allSettled([
        loadComments(),
        refreshScrapButton(),
        loadPrevNextLinks(),
        canViewHidden ? loadPostFiles() : Promise.resolve(),
        loadAuthorRecentPosts(),
        loadBoardList()
      ]);
      for (const task of tasks) {
        if (task.status === "rejected") {
          console.error("Post Render Error:", task.reason);
        }
      }
    }

    function renderNeighborLink(nodeId, label, post) {
      const node = $(nodeId);
      if (!post) {
        node.classList.add("hidden");
        node.textContent = "";
        node.removeAttribute("href");
        return;
      }
      const comments = Number(post.comment_count || 0);
      node.href = `/post.html?id=${post.id}`;
      node.textContent = `${label}: ${post.title}${comments > 0 ? ` (${comments})` : ""}`;
      node.classList.remove("hidden");
    }

    async function loadPrevNextLinks() {
      if (!currentPost?.section_slug || !currentPost?.created_at) return;
      const [prevRes, nextRes] = await Promise.all([
        applyNotDeletedFilter(
          sbClient
            .from("board_posts_active")
            .select("id,title,comment_count,created_at")
            .eq("section_slug", currentPost.section_slug)
            .gt("created_at", currentPost.created_at)
        )
          .order("created_at", { ascending: true })
          .limit(1)
          .maybeSingle(),
        applyNotDeletedFilter(
          sbClient
            .from("board_posts_active")
            .select("id,title,comment_count,created_at")
            .eq("section_slug", currentPost.section_slug)
            .lt("created_at", currentPost.created_at)
        )
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle()
      ]);
      renderNeighborLink("prevPostLink", "ì´ì „ê¸€", prevRes.data || null);
      renderNeighborLink("nextPostLink", "ë‹¤ìŒê¸€", nextRes.data || null);
    }

    async function loadAuthorRecentPosts() {
      if (!currentPost?.author_id || !currentPost?.section_slug) return;
      const section = $("authorRecentSection");
      const list = $("authorRecentList");
      section.classList.add("hidden");
      list.innerHTML = "";

      let query = applyNotDeletedFilter(
        sbClient
          .from("board_posts_active")
          .select("id,title,created_at,comment_count")
          .eq("section_slug", currentPost.section_slug)
          .eq("author_id", currentPost.author_id)
          .neq("id", currentPost.id)
      )
        .order("created_at", { ascending: false })
        .limit(10);
      let { data, error } = await query;
      if (error) return;

      const rows = data || [];
      if (!rows.length) return;
      section.classList.remove("hidden");
      $("authorRecentName").textContent = authorName(currentPost.author_id, currentPost.author_display, Boolean(currentPost.is_anonymous));
      list.innerHTML = rows.map((row) => {
        const comments = Number(row.comment_count || 0);
        const dt = APP.formatYmd(row.created_at);
        return `<a href="/post.html?id=${row.id}" class="hover:underline">${esc(row.title)}${comments > 0 ? ` (${comments})` : ""} <span class="mono text-xs text-slate-400">${dt}</span></a>`;
      }).join("");
    }

    async function loadBoardList() {
      if (!currentPost?.section_slug) return;
      const tbody = $("boardListTbody");
      tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-sm font-black text-slate-400">ë¡œë”© ì¤‘...</td></tr>';

      let query = applyNotDeletedFilter(
        sbClient
          .from("board_posts_active")
          .select(`id,title,author_id,author_display,created_at,view_count,like_count,comment_count${postSchema.boardSeqAvailable ? ",board_seq" : ""}`)
          .eq("section_slug", currentPost.section_slug)
      )
        .order("created_at", { ascending: false })
        .limit(20);
      let { data, error } = await query;
      if (error && postSchema.boardSeqAvailable && isMissingBoardSeqError(error)) {
        postSchema.boardSeqAvailable = false;
        query = applyNotDeletedFilter(
          sbClient
            .from("board_posts_active")
            .select("id,title,author_id,author_display,created_at,view_count,like_count,comment_count")
            .eq("section_slug", currentPost.section_slug)
        )
          .order("created_at", { ascending: false })
          .limit(20);
        ({ data, error } = await query);
      }
      if (error) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-3 py-4 text-sm font-black text-rose-700">${esc(error.message || "ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜")}</td></tr>`;
        return;
      }

      const rows = data || [];
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-sm font-black text-slate-400">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      await loadProfileMap([currentPost.author_id, ...rows.map((row) => row.author_id)]);
      tbody.innerHTML = rows.map((row) => {
        const isCurrent = Number(row.id) === Number(currentPost.id);
        const author = authorName(row.author_id, row.author_display, false);
        const boardNo = Number(row?.board_seq || 0);
        const displayNo = Number.isFinite(boardNo) && boardNo > 0 ? boardNo : Number(row?.id || 0);
        return `
          <tr class="${isCurrent ? "bg-amber-50" : ""}">
            <td class="px-3 py-2 mono font-black text-slate-600">${displayNo > 0 ? displayNo : "-"}</td>
            <td class="px-3 py-2">
              <a href="/post.html?id=${row.id}" class="font-black hover:underline">${esc(row.title)}</a>
              ${Number(row.comment_count || 0) > 0 ? `<span class="mono text-xs text-slate-500 ml-1">(${Number(row.comment_count || 0)})</span>` : ""}
            </td>
            <td class="px-3 py-2 font-black text-slate-700">${esc(author)}</td>
            <td class="px-3 py-2 mono font-black text-slate-500">${APP.formatYmd(row.created_at)}</td>
            <td class="px-3 py-2 text-right mono font-black text-slate-600">${Number(row.view_count || 0)}</td>
            <td class="px-3 py-2 text-right mono font-black text-slate-600">${Number(row.like_count || 0)}</td>
          </tr>
        `;
      }).join("");
    }

    function commentLikeCount(comment) {
      if (commentLikeCountMap.has(comment.id)) return commentLikeCountMap.get(comment.id) || 0;
      const base = Number(comment.like_count || 0);
      if (commentLikesTableReady === false && commentLikedByMe.has(comment.id)) return base + 1;
      return base;
    }

    function renderCommentNodes(byParent, parentId, depth, pathSet) {
      if (depth > MAX_COMMENT_RENDER_DEPTH) {
        return '<div class="mt-2 text-xs font-black text-amber-700">ë‹µê¸€ ê¹Šì´ ì œí•œìœ¼ë¡œ ì¼ë¶€ ëŒ“ê¸€ì´ ì ‘í˜”ìŠµë‹ˆë‹¤.</div>';
      }
      const nodes = byParent.get(parentId) || [];
      if (!nodes.length) return "";
      return nodes.map((comment) => {
        const commentId = Number(comment.id || 0);
        if (!Number.isFinite(commentId) || commentId < 1) return "";
        if (pathSet.has(commentId)) {
          return '<div class="mt-2 text-xs font-black text-rose-700">ëŒ“ê¸€ êµ¬ì¡° ì˜¤ë¥˜(ìˆœí™˜ ì°¸ì¡°)ë¥¼ ê°ì§€í•´ ì¶œë ¥ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
        const canDeleteComment = Boolean(isBoardAdmin || comment.can_delete);
        const likedByMe = commentLikedByMe.has(comment.id);
        const likeCount = commentLikeCount(comment);
        const avatar = String(comment.avatar_url || "");
        const author = authorName(null, comment.nickname || comment.author_display);
        const nextPath = new Set(pathSet);
        nextPath.add(commentId);
        const children = renderCommentNodes(byParent, comment.id, depth + 1, nextPath);
        const margin = Math.min(depth, 9) * 20;
        return `
          <article class="border-t border-slate-200 pt-3 mt-3" style="margin-left:${margin}px;">
            <div class="flex items-start gap-2">
              <div class="comment-avatar">
                ${avatar ? `<img src="${esc(avatar)}" alt="avatar" class="h-full w-full object-cover" />` : `<div class="h-full w-full text-[11px] text-slate-500 font-black flex items-center justify-center">${esc(String(author).slice(0, 1))}</div>`}
              </div>
              <div class="min-w-0 flex-1">
                <div class="text-xs font-black text-slate-400 flex items-center justify-between">
                  <span class="text-sm text-slate-700">${esc(author)}</span>
                  <div class="flex items-center gap-2">
                    <span class="mono">${new Date(comment.created_at).toLocaleString("ko-KR")}</span>
                    ${canDeleteComment ? `<button data-comment-delete="${comment.id}" class="px-2 py-1 border border-slate-300 text-[11px] font-black text-rose-600 hover:bg-rose-50">ì‚­ì œ</button>` : ""}
                  </div>
                </div>
                <div class="mt-2 font-bold text-slate-800 whitespace-pre-wrap">${esc(comment.body)}</div>
                ${comment.image_url ? `<img src="${esc(comment.image_url)}" alt="comment image" class="mt-2 max-h-72 border border-slate-200" />` : ""}
                <div class="mt-2 flex items-center gap-3 text-xs font-black">
                  <button data-comment-reply-open="${comment.id}" class="text-slate-500 hover:text-slate-700">â†ª ë‹µê¸€</button>
                  <button data-comment-like="${comment.id}" class="${likedByMe ? "text-blue-700" : "text-slate-500"} hover:text-blue-700">ğŸ‘ ${likeCount}</button>
                </div>
                <div class="hidden mt-2 border border-slate-200 bg-slate-50 p-2" data-comment-reply-form="${comment.id}">
                  <textarea data-comment-reply-input="${comment.id}" rows="2" class="w-full border border-slate-300 px-2 py-1 text-sm font-bold" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                  <div class="mt-2 flex items-center justify-between gap-2">
                    <label class="inline-flex items-center gap-1 text-xs font-black text-slate-600 cursor-pointer">
                      <input type="file" accept="image/*" data-comment-reply-file="${comment.id}" class="hidden" />
                      ì‚¬ì§„
                    </label>
                    <span data-comment-reply-file-name="${comment.id}" class="text-xs font-bold text-slate-500">ì‚¬ì§„ ì—†ìŒ</span>
                    <button data-comment-reply-submit="${comment.id}" class="px-3 py-1 bg-[#5467AC] text-white text-xs font-black hover:brightness-110">ëŒ“ê¸€ì“°ê¸°</button>
                  </div>
                </div>
                ${children}
              </div>
            </div>
          </article>
        `;
      }).join("");
    }

    async function loadComments() {
      const commentLabel = $("commentCountLabel");
      const commentList = $("commentList");
      if (!commentLabel || !commentList) return;

      const { data, error } = await sbClient.rpc("get_post_comments_secure", { p_post_id: postId });

      if (error) {
        const msg = String(error.message || "");
        if (msg.toLowerCase().includes("room_access_denied") || msg.toLowerCase().includes("permission denied")) {
          commentLabel.textContent = "ëŒ“ê¸€ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
        } else if (msg.toLowerCase().includes("get_post_comments_secure") && msg.toLowerCase().includes("does not exist")) {
          commentLabel.textContent = "ë³´ì•ˆ ëŒ“ê¸€ ì¡°íšŒ í•¨ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        } else {
          commentLabel.textContent = error.message;
        }
        return;
      }

      const rows = (data || []).map((row) => {
        const parsed = parseCommentMeta(row);
        return {
          id: Number(row.id),
          nickname: String(row.nickname || "").trim(),
          author_display: row.author_display,
          body: parsed.body,
          created_at: row.created_at,
          parent_id: parsed.parentId,
          image_path: parsed.imagePath,
          like_count: Number(row.like_count || 0),
          image_url: "",
          avatar_path: String(row.avatar_path || "").trim(),
          avatar_url: "",
          can_delete: Boolean(row.can_delete)
        };
      });

      const imagePaths = [...new Set(rows.map((row) => row.image_path).filter(Boolean))];
      const imagePairs = await Promise.all(imagePaths.map(async (path) => {
        const url = await APP.resolveBoardUploadUrl(path);
        return [path, url];
      }));
      const imageUrlMap = new Map(imagePairs.filter(([, url]) => Boolean(url)));
      rows.forEach((row) => {
        if (row.image_path) row.image_url = imageUrlMap.get(row.image_path) || "";
      });

      const avatarPaths = [...new Set(rows.map((row) => row.avatar_path).filter(Boolean))];
      const avatarPairs = await Promise.all(avatarPaths.map(async (path) => {
        const url = await APP.resolveAvatarUrl(path);
        return [path, url];
      }));
      const avatarUrlLookup = new Map(avatarPairs.filter(([, url]) => Boolean(url)));
      rows.forEach((row) => {
        if (row.avatar_path) row.avatar_url = avatarUrlLookup.get(row.avatar_path) || "";
      });

      commentLikeCountMap = new Map();
      commentLikedByMe = new Set();
      const ready = await ensureCommentLikesTableReady();
      const commentIds = rows.map((row) => row.id).filter((v) => Number.isFinite(v) && v > 0);
      if (ready && commentIds.length) {
        const { data: allLikeRows } = await sbClient
          .from("board_comment_likes")
          .select("comment_id")
          .in("comment_id", commentIds)
          .limit(Math.max(800, commentIds.length * 40));
        for (const row of (allLikeRows || [])) {
          const cid = Number(row.comment_id || 0);
          if (!Number.isFinite(cid) || cid < 1) continue;
          commentLikeCountMap.set(cid, (commentLikeCountMap.get(cid) || 0) + 1);
        }
        if (currentUser) {
          const { data: mineRows } = await sbClient
            .from("board_comment_likes")
            .select("comment_id")
            .in("comment_id", commentIds)
            .eq("user_id", currentUser.id)
            .limit(Math.max(300, commentIds.length * 4));
          for (const row of (mineRows || [])) {
            const cid = Number(row.comment_id || 0);
            if (!Number.isFinite(cid) || cid < 1) continue;
            commentLikedByMe.add(cid);
          }
        }
      } else {
        rows.forEach((row) => {
          if (Number.isFinite(Number(row.id))) commentLikeCountMap.set(Number(row.id), Number(row.like_count || 0));
        });
        rows.forEach((row) => {
          if (isCommentLikedLocally(row.id)) commentLikedByMe.add(row.id);
        });
      }

      const byParent = new Map();
      const ids = new Set(rows.map((row) => Number(row.id)).filter((v) => Number.isFinite(v) && v > 0));
      rows.forEach((row) => {
        const parent = Number(row.parent_id || 0);
        const key = Number.isFinite(parent) && parent > 0 && parent !== Number(row.id) && ids.has(parent) ? parent : 0;
        if (!byParent.has(key)) byParent.set(key, []);
        byParent.get(key).push(row);
      });

      const roots = byParent.get(0) || [];
      commentList.innerHTML = roots.length
        ? renderCommentNodes(byParent, 0, 0, new Set())
        : '<div class="text-sm font-bold text-slate-500">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</div>';

      commentLabel.textContent = `${rows.length}ê°œ`;
    }

    async function refreshScrapButton() {
      if (!currentUser || !currentPost) return;
      if (!$("btnScrap")) return;
      const { data: scrapData } = await sbClient
        .from("board_post_scraps")
        .select("post_id")
        .eq("post_id", postId)
        .eq("user_id", currentUser.id)
        .maybeSingle();
      $("btnScrap").textContent = scrapData ? "ìŠ¤í¬ë© í•´ì œ" : "ìŠ¤í¬ë©";
    }

    function voteErrorMessage(statusCode, payload) {
      const reason = String(payload?.reason || "");
      if (reason === "self_vote") return "ë³¸ì¸ ê²Œì‹œë¬¼ì€ ì¶”ì²œ/ë¹„ì¶”ì²œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      if (statusCode === 401) return "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
      if (statusCode === 400 && reason === "ip_unavailable") return "ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ íˆ¬í‘œë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      if (statusCode === 409 || reason === "already_voted") return "ì´ë¯¸ ì´ ê²Œì‹œë¬¼ì— íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤.";
      return "íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
    }

    async function submitVote(voteValue) {
      if (!currentPost?.id || votePending) return;
      clearVoteMsg();
      votePending = true;
      $("btnLike").disabled = true;
      $("btnDislike").disabled = true;
      try {
        const { data: sessData } = await sbClient.auth.getSession();
        const accessToken = sessData?.session?.access_token;
        const headers = { "Content-Type": "application/json" };
        if (accessToken) headers.Authorization = `Bearer ${accessToken}`;
        const res = await fetch("/.netlify/functions/vote-post", {
          method: "POST",
          headers,
          body: JSON.stringify({ post_id: currentPost.id, vote: voteValue }),
        });
        const payload = await res.json().catch(() => null);
        if (res.ok && payload?.ok) {
          if (Number.isFinite(Number(payload.like_count))) {
            const nextLike = Number(payload.like_count);
            $("postLikes").textContent = String(nextLike);
            currentPost.like_count = nextLike;
          }
          if (Number.isFinite(Number(payload.dislike_count))) {
            const nextDislike = Number(payload.dislike_count);
            $("postDislikes").textContent = String(nextDislike);
            currentPost.dislike_count = nextDislike;
          }
          syncVoteButtons();
          if (payload.changed === false) {
            setVoteMsg("ì´ë¯¸ ì´ ê²Œì‹œë¬¼ì— íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤.");
          }
          return;
        }
        setVoteMsg(voteErrorMessage(res.status, payload));
        if (res.status === 401) APP.openAuth("login");
      } catch {
        setVoteMsg("íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
      } finally {
        votePending = false;
        $("btnLike").disabled = false;
        $("btnDislike").disabled = false;
      }
    }

    async function submitReport() {
      if (!currentPost?.id || reportPending) return;
      if (!currentUser) return APP.openAuth("login");
      clearReportMsg();
      reportPending = true;
      $("btnReport").disabled = true;
      try {
        const { data: sessData } = await sbClient.auth.getSession();
        const accessToken = sessData?.session?.access_token;
        const headers = { "Content-Type": "application/json" };
        if (accessToken) headers.Authorization = `Bearer ${accessToken}`;
        const res = await fetch("/.netlify/functions/report-post", {
          method: "POST",
          headers,
          body: JSON.stringify({ post_id: currentPost.id })
        });
        const payload = await res.json().catch(() => null);
        if (res.ok && payload?.ok) {
          if (Number.isFinite(Number(payload.report_count))) currentPost.report_count = Number(payload.report_count);
          if (typeof payload.is_hidden === "boolean") currentPost.is_hidden = payload.is_hidden;
          if (payload.is_hidden) setReportMsg("ì‹ ê³  ëˆ„ì ìœ¼ë¡œ ê¸€ì´ ìˆ¨ê¹€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
          else setReportMsg(`ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. (${payload.report_count}/${payload.threshold})`);
          await loadPost();
          return;
        }
        if (res.status === 409) {
          setReportMsg("ì´ë¯¸ ì‹ ê³ í•œ ê¸€ì…ë‹ˆë‹¤.");
          return;
        }
        if (res.status === 401) {
          APP.openAuth("login");
          return;
        }
        setReportMsg(payload?.message || "ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } catch {
        setReportMsg("ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        reportPending = false;
        $("btnReport").disabled = false;
      }
    }

    async function insertCommentWithMeta({ text, parentId = null, imageFile = null }) {
      if (parentId) {
        const parentCheck = await validateCommentReplyTarget(parentId, postId);
        if (!parentCheck.ok) {
          setCommentMsg(parentCheck.message || "ë‹µê¸€ ëŒ€ìƒì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return false;
        }
      }
      let imagePath = "";
      if (imageFile) {
        if (imageFile.size > MAX_FILE_SIZE) {
          setCommentMsg("ì´ë¯¸ì§€ ìš©ëŸ‰ì€ 4MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return false;
        }
        const path = `comments/${postId}/${Date.now()}_${APP.sanitizeFilename(imageFile.name)}`;
        const { error: uploadError } = await sbClient.storage.from(FILE_BUCKET).upload(path, imageFile, {
          upsert: false,
          contentType: imageFile.type || "application/octet-stream"
        });
        if (uploadError) {
          setCommentMsg(uploadError.message || "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
          return false;
        }
        imagePath = path;
      }

      const encodedBody = buildCommentBody(text, parentId, imagePath);
      let payload = {
        post_id: postId,
        author_id: currentUser.id,
        author_display: profileNickname || await getMyDisplayName(),
        body: String(text || "").trim()
      };
      if (parentId && commentParentAvailable) payload.parent_id = Number(parentId);
      if (imagePath && commentImagePathAvailable) payload.image_path = imagePath;
      if ((parentId && !commentParentAvailable) || (imagePath && !commentImagePathAvailable)) {
        payload.body = encodedBody;
      }

      for (;;) {
        const { error } = await sbClient.from("board_comments").insert(payload);
        if (!error) return true;

        let removed = false;
        if ("author_display" in payload && isMissingAuthorDisplayError(error)) {
          postSchema.authorDisplayAvailable = false;
          delete payload.author_display;
          removed = true;
        }
        if ("parent_id" in payload && isMissingParentIdError(error)) {
          commentParentAvailable = false;
          delete payload.parent_id;
          payload.body = encodedBody;
          removed = true;
        }
        if ("image_path" in payload && isMissingImagePathError(error)) {
          commentImagePathAvailable = false;
          delete payload.image_path;
          payload.body = encodedBody;
          removed = true;
        }
        if (!removed) {
          setCommentMsg(error.message || "ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
          return false;
        }
      }
    }

    async function toggleCommentLike(commentId) {
      if (!currentUser) return APP.openAuth("login");
      const ready = await ensureCommentLikesTableReady();
      if (!ready) {
        const liked = isCommentLikedLocally(commentId);
        setCommentLikedLocally(commentId, !liked);
        await loadComments();
        return;
      }
      const { data } = await sbClient
        .from("board_comment_likes")
        .select("id")
        .eq("comment_id", commentId)
        .eq("user_id", currentUser.id)
        .maybeSingle();
      if (data?.id) {
        await sbClient.from("board_comment_likes").delete().eq("id", data.id);
      } else {
        await sbClient.from("board_comment_likes").insert({ comment_id: commentId, user_id: currentUser.id });
      }
      await loadComments();
    }

    $("btnAddComment")?.addEventListener("click", async () => {
      clearCommentMsg();
      if (!currentUser) return APP.openAuth("login");
      const body = $("commentBody").value.trim();
      if (!body) return setCommentMsg("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const imageFile = $("commentImageInput").files?.[0] || null;
      const ok = await insertCommentWithMeta({ text: body, imageFile });
      if (!ok) return;
      $("commentBody").value = "";
      $("commentImageInput").value = "";
      $("commentImageLabel").textContent = "ì‚¬ì§„ ì—†ìŒ";
      await loadPost();
    });

    $("commentImageInput")?.addEventListener("change", () => {
      const file = $("commentImageInput").files?.[0];
      $("commentImageLabel").textContent = file ? file.name : "ì‚¬ì§„ ì—†ìŒ";
    });

    $("commentList")?.addEventListener("change", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement)) return;
      const replyId = target.dataset.commentReplyFile;
      if (!replyId) return;
      const label = $("commentList").querySelector(`[data-comment-reply-file-name="${replyId}"]`);
      if (label) label.textContent = target.files?.[0]?.name || "ì‚¬ì§„ ì—†ìŒ";
    });

    $("commentList")?.addEventListener("click", async (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;

      const likeId = Number(target.dataset.commentLike || "");
      if (Number.isFinite(likeId) && likeId > 0) {
        await toggleCommentLike(likeId);
        return;
      }

      const openReplyId = Number(target.dataset.commentReplyOpen || "");
      if (Number.isFinite(openReplyId) && openReplyId > 0) {
        const form = $("commentList").querySelector(`[data-comment-reply-form="${openReplyId}"]`);
        if (form) form.classList.toggle("hidden");
        return;
      }

      const submitReplyId = Number(target.dataset.commentReplySubmit || "");
      if (Number.isFinite(submitReplyId) && submitReplyId > 0) {
        if (!currentUser) return APP.openAuth("login");
        const input = $("commentList").querySelector(`[data-comment-reply-input="${submitReplyId}"]`);
        const fileInput = $("commentList").querySelector(`[data-comment-reply-file="${submitReplyId}"]`);
        if (!(input instanceof HTMLTextAreaElement) || !(fileInput instanceof HTMLInputElement)) return;
        const body = input.value.trim();
        if (!body) return setCommentMsg("ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        const ok = await insertCommentWithMeta({
          text: body,
          parentId: submitReplyId,
          imageFile: fileInput.files?.[0] || null
        });
        if (!ok) return;
        await loadPost();
        return;
      }

      const id = Number(target.dataset.commentDelete || "");
      if (!Number.isFinite(id)) return;
      if (!currentUser) return APP.openAuth("login");
      if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
      const { error } = await sbClient
        .from("board_comments")
        .update({ is_deleted: true, deleted_at: new Date().toISOString() })
        .eq("id", id);
      if (error) {
        alert(error.message || "ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨");
        return;
      }
      await loadPost();
    });

    $("btnLike")?.addEventListener("click", async () => {
      await submitVote(1);
    });

    $("btnDislike")?.addEventListener("click", async () => {
      await submitVote(-1);
    });

    $("btnScrap")?.addEventListener("click", async () => {
      if (!currentUser) return APP.openAuth("login");
      const { data } = await sbClient.from("board_post_scraps").select("post_id").eq("post_id", postId).eq("user_id", currentUser.id).maybeSingle();
      if (data) {
        await sbClient.from("board_post_scraps").delete().eq("post_id", postId).eq("user_id", currentUser.id);
      } else {
        await sbClient.from("board_post_scraps").insert({ post_id: postId, user_id: currentUser.id });
      }
      await refreshScrapButton();
    });

    $("btnReport")?.addEventListener("click", async () => {
      await submitReport();
    });

    $("btnDelete")?.addEventListener("click", async () => {
      if (!currentUser) return APP.openAuth("login");
      const canDelete = Boolean(currentPost && (currentUser.id === currentPost.author_id || isBoardAdmin));
      if (!canDelete) return;
      if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      try {
        const { data: sessData } = await sbClient.auth.getSession();
        const accessToken = sessData?.session?.access_token || "";
        const headers = { "Content-Type": "application/json; charset=utf-8" };
        if (accessToken) headers.Authorization = `Bearer ${accessToken}`;
        const res = await fetch("/.netlify/functions/delete-post", {
          method: "POST",
          headers,
          body: JSON.stringify({ post_id: postId }),
        });
        const payload = await res.json().catch(() => null);
        if (!res.ok || !payload?.ok) {
          alert(payload?.message || "ì‚­ì œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
          return;
        }
      } catch {
        alert("ì‚­ì œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return;
      }
      location.href = `/board.html?b=${encodeURIComponent(currentPost.section_slug || "free")}`;
    });

    (async function init() {
      try {
        APP.setupMobileMenu("btnMobileMenu", "mobileMenu");
        APP.setupContactModal();
        APP.setupAuthModal();
        APP.setupSecretRoomHover({
          elementId: "room-of-requirement",
          hiddenColor: "#7092BE",
          hoverColor: "#7496C2",
          openColor: "#FFFFFF",
          requiredCount: 3,
          withinMs: 1500,
          resetMs: 1500
        });
        const preview = $("kakaoLinkPreview");
        if (preview) preview.textContent = APP.getKakaoOpenChatUrl();
        $("authGateLoginBtn")?.addEventListener("click", () => APP.openAuth("login"));
        $("authGateSignupBtn")?.addEventListener("click", () => APP.openAuth("signup"));

        const { data } = await sbClient.auth.getSession();
        await syncAuthUI(data.session);

        sbClient.auth.onAuthStateChange(async (_evt, session) => {
          try {
            await syncAuthUI(session);
            $("authGateNotice")?.classList.add("hidden");
            await refreshScrapButton();
            await loadPost();
          } catch (error) {
            console.error("Post Auth Sync Error:", error);
          }
        });

        // ì¼ë°˜ ê¸€ì€ ë¹„ë¡œê·¸ì¸ ì—´ëŒ í—ˆìš©. room ê¸€ì€ RLSì—ì„œ 42501ë¡œ ë§‰íˆë¯€ë¡œ loadPost()ì—ì„œ ì²˜ë¦¬.
        $("authGateNotice")?.classList.add("hidden");
        await loadPost();
      } catch (error) {
        console.error("Post Init Error:", error);
      }
    })();
  </script>
</body>
</html>


